<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}نظام فكرة للإدارة{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="alternate icon" href="/favicon.ico">

    <!-- LOCAL RESOURCES FIRST (Essential) -->
    <link rel="stylesheet" href="/static/fallback.css">
    <link rel="stylesheet" href="/static/dashboard.css">
    <link rel="stylesheet" href="/static/style.css">

    <!-- Load local fallback JavaScript immediately -->
    <script src="/static/bootstrap-fallback.js"></script>
    <script src="/static/offline-detector.js"></script>

    <!-- CDN Enhancement System (Non-blocking) -->
    <script>
        // Prevent multiple CDN loading attempts
        window.cdnLoadingInProgress = window.cdnLoadingInProgress || false;
        window.cdnLoadedResources = window.cdnLoadedResources || new Set();

        // Ultra-Robust CDN loader with multiple fallback layers
        function loadCDNResource(url, type, fallback) {
            if (window.cdnLoadedResources.has(url)) {
                return Promise.resolve();
            }

            return new Promise((resolve) => {
                // Always resolve, never reject to prevent errors
                let element;
                let hasTimedOut = false;

                if (type === 'css') {
                    element = document.createElement('link');
                    element.rel = 'stylesheet';
                    element.href = url;
                } else if (type === 'js') {
                    element = document.createElement('script');
                    element.src = url;
                    element.defer = true;
                }

                const cleanup = () => {
                    window.cdnLoadedResources.add(url);
                    if (element && element.parentNode) {
                        // Don't remove on error, might still load
                    }
                };

                const onSuccess = () => {
                    if (hasTimedOut) return;
                    cleanup();
                    console.log(`✅ CDN enhanced: ${url.substring(0, 50)}...`);
                    resolve();
                };

                const onFailure = () => {
                    cleanup();
                    console.log(`📦 Using local fallback for: ${url.substring(0, 50)}...`);

                    // Try fallback if available
                    if (fallback && !window.cdnLoadedResources.has(fallback)) {
                        setTimeout(() => {
                            loadCDNResource(fallback, type).then(() => {
                                console.log(`✅ Fallback CDN worked: ${fallback.substring(0, 50)}...`);
                            }).catch(() => {
                                console.log(`📦 All CDNs unavailable, using local resources`);
                            });
                        }, 100);
                    }
                    resolve(); // Always resolve to continue execution
                };

                // Ultra-short timeout for 503 errors (1 second)
                const timeout = setTimeout(() => {
                    hasTimedOut = true;
                    onFailure();
                }, 1000);

                element.onload = () => {
                    clearTimeout(timeout);
                    onSuccess();
                };

                element.onerror = () => {
                    clearTimeout(timeout);
                    onFailure();
                };

                // Add to head with error suppression
                try {
                    document.head.appendChild(element);
                } catch (e) {
                    console.log(`📦 CDN append failed, using local resources: ${e.message}`);
                    resolve();
                }
            });
        }

        // Make function globally available
        window.loadCDNResource = loadCDNResource;

        // Optimized CDN Enhancement - Completely Optional
        document.addEventListener('DOMContentLoaded', function () {
            if (window.cdnLoadingInProgress) return;
            window.cdnLoadingInProgress = true;

            console.log('🚀 ERP System: Loading CDN enhancements (local resources active)...');

            // All CDN loading is now optional enhancement - system fully functional without it
            Promise.allSettled([
                loadCDNResource('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css', 'css',
                    'https://use.fontawesome.com/releases/v6.0.0/css/all.css'),
                loadCDNResource('https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.rtl.min.css', 'css',
                    'https://unpkg.com/bootstrap@5.1.3/dist/css/bootstrap.rtl.min.css'),
                loadCDNResource('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap', 'css',
                    'https://fonts.bunny.net/css2?family=Cairo:wght@300;400;500;600;700&display=swap')
            ]).then(() => {
                console.log('✅ ERP System: CDN enhancement phase completed (or skipped)');
                console.log('📦 System Status: Fully operational with local resources');
                window.cdnLoadingInProgress = false;
            }).catch(() => {
                // This should never happen as we always resolve, but just in case
                console.log('📦 ERP System: Operating with local resources only');
                window.cdnLoadingInProgress = false;
            });
        });
    </script>

    <!-- Enhanced Offline-First Fallback System -->
    <style>
        /* Complete offline fonts - no external dependencies */
        @font-face {
            font-family: 'Cairo-Local';
            src: local('Cairo'), local('Segoe UI'), local('Tahoma');
            font-weight: 300 700;
            font-display: swap;
        }

        /* Robust font fallback chain - no CDN dependencies */
        * {
            font-family: 'Cairo-Local', 'Cairo', 'Tajawal', 'Segoe UI', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }

        /* Enhanced icon fallbacks with emoji backup */
        .fas::before,
        .fab::before,
        .far::before,
        .fa::before {
            font-family: 'FontAwesome', 'Font Awesome 5 Free', 'Font Awesome 5 Brands', monospace !important;
            speak: never;
            font-style: normal;
            font-weight: normal !important;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Icon emoji fallbacks for completely offline operation */
        .fa-rocket::before {
            content: "🚀";
        }

        .fa-chart-pie::before {
            content: "📊";
        }

        .fa-briefcase::before {
            content: "💼";
        }

        .fa-check-square::before {
            content: "✅";
        }

        .fa-user-tie::before {
            content: "👔";
        }

        .fa-users-cog::before {
            content: "⚙️";
        }

        .fa-credit-card::before {
            content: "💳";
        }

        .fa-chart-area::before {
            content: "📈";
        }

        .fa-sliders-h::before {
            content: "🎛️";
        }

        .fa-power-off::before {
            content: "⏻";
        }

        .fa-plus::before {
            content: "➕";
        }

        .fa-plus-circle::before {
            content: "⊕";
        }

        .fa-edit::before {
            content: "✏️";
        }

        .fa-eye::before {
            content: "👁️";
        }

        .fa-trash::before {
            content: "🗑️";
        }

        .fa-save::before {
            content: "💾";
        }

        .fa-search::before {
            content: "🔍";
        }

        .fa-filter::before {
            content: "🔽";
        }

        .fa-download::before {
            content: "⬇️";
        }

        .fa-upload::before {
            content: "⬆️";
        }

        .fa-print::before {
            content: "🖨️";
        }

        .fa-bell::before {
            content: "🔔";
        }

        .fa-cog::before {
            content: "⚙️";
        }

        .fa-home::before {
            content: "🏠";
        }

        .fa-times::before {
            content: "✖️";
        }

        .fa-check::before {
            content: "✔️";
        }

        .fa-chevron-down::before {
            content: "⌄";
        }

        .fa-chevron-up::before {
            content: "⌃";
        }

        .fa-chevron-left::before {
            content: "‹";
        }

        .fa-chevron-right::before {
            content: "›";
        }

        * {
            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Tahoma, Arial, sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --sidebar-width: 280px;
            --header-height: 65px;
            --border-radius: 10px;
            --transition-smooth: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #2d3748;
            overflow-x: hidden;
        }

        .mobile-menu-toggle {
            display: none;
            background: transparent;
            border: none;
            color: #667eea;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .mobile-menu-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }

        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }

        .mobile-overlay.show {
            opacity: 1;
            visibility: visible;
            right: 77%;
            /* Don't cover the sidebar area */
            max-width: calc(100% - 300px);
            /* Ensure it doesn't overlap sidebar */
            left: 0;
            width: auto;
        }

        .modern-header {
            position: fixed;
            top: 0;
            left: 0;
            right: var(--sidebar-width);
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 1.2rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 30px;
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .user-profile i {
            transition: transform 0.3s ease;
        }

        .user-profile:hover {
            background: rgba(102, 126, 234, 0.15);
            transform: translateY(-1px);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* User Dropdown Menu */
        .user-menu-container {
            position: relative;
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(226, 232, 240, 0.8);
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 2000;
            min-width: 220px;
            margin-top: 8px;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-dropdown::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: white;
            border: 1px solid rgba(226, 232, 240, 0.8);
            border-bottom: none;
            border-right: none;
            transform: translateX(-50%) rotate(45deg);
        }

        .user-info {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .user-info-name {
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.3rem;
            font-size: 0.95rem;
        }

        .user-info-role {
            font-size: 0.8rem;
            color: #718096;
        }

        .user-info-email {
            font-size: 0.8rem;
            color: #4a5568;
            margin-top: 0.2rem;
        }

        .dropdown-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.5rem;
            color: #4a5568;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 0.9rem;
            border: none;
            background: none;
            width: 100%;
            text-align: right;
        }

        .dropdown-menu-item:hover {
            background: rgba(102, 126, 234, 0.08);
            color: #667eea;
            transform: translateX(-3px);
        }

        .dropdown-menu-item i {
            width: 16px;
            text-align: center;
            font-size: 0.9rem;
        }

        .dropdown-menu-item.danger {
            color: #e53e3e;
        }

        .dropdown-menu-item.danger:hover {
            background: rgba(229, 62, 62, 0.08);
            color: #e53e3e;
        }

        .modern-sidebar {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
            padding: 2rem 0;
            z-index: 1051;
            overflow-y: auto;
            transition: var(--transition-smooth);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.1);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0 2rem 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-icon {
            width: 45px;
            height: 45px;
            border-radius: var(--border-radius);
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4rem;
        }

        .brand-text {
            color: white;
        }

        .brand-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .brand-subtitle {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .sidebar-nav {
            padding: 0 1.5rem;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition-smooth);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            /* Improve touch targets for mobile */
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(102, 126, 234, 0.3);
            color: white;
            transform: translateX(-3px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }

        .main-content {
            margin-right: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 2rem;
            min-height: calc(100vh - var(--header-height));
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .modern-header {
                right: 0;
                left: 0;
                padding: 0 1.5rem;
            }

            .header-left {
                flex: 1;
            }

            .mobile-overlay {
                pointer-events: none;
            }

            .mobile-overlay.show {
                pointer-events: all;
                right: 40%;
                /* Don't cover the sidebar area */
                max-width: calc(100% - 300px);
                /* Ensure it doesn't overlap sidebar */
            }

            .modern-sidebar {
                transform: translateX(100%);
                width: 85%;
                max-width: 320px;
                opacity: 1;
                background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
                box-shadow: -8px 0 30px rgba(0, 0, 0, 0.3);
                z-index: 1002;
                /* Higher than overlay */
            }

            .modern-sidebar.show {
                transform: translateX(0);
                opacity: 1;
            }

            .main-content {
                margin-right: 0;
                margin-top: var(--header-height);
                padding: 1.5rem;
            }
        }

        /* Enhanced Sidebar Icon Styling */
        .sidebar-brand .brand-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
        }

        .sidebar-brand .brand-icon:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }

        .nav-link {
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .nav-link:hover::before {
            left: 100%;
        }

        .nav-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-link:hover .nav-icon {
            transform: scale(1.2);
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .nav-link.active .nav-icon {
            transform: scale(1.15);
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* Icon Glow Effect */
        .brand-icon i {
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        /* Animated Icon on Page Load */
        @keyframes iconFloat {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        .brand-icon {
            animation: iconFloat 3s ease-in-out infinite;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>

<body>
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <header class="modern-header">
        <div class="header-left">
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="فتح القائمة">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="header-title">{% block page_title %}لوحة التحكم{% endblock %}</h1>
        </div>
        <div class="header-actions">
            <div class="user-menu-container">
                <div class="user-profile" onclick="toggleUserMenu()" id="userProfile">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">المدير</span>
                    <i class="fas fa-chevron-down" id="userMenuIcon"></i>
                </div>

                <!-- User Dropdown Menu -->
                <div class="user-dropdown" id="userDropdown">
                    <div class="user-info">
                        <div class="user-info-name" id="dropdownUserName">المدير</div>
                        <div class="user-info-role" id="dropdownUserRole">مدير النظام</div>
                        <div class="user-info-email" id="dropdownUserEmail">admin@company.com</div>
                    </div>

                    <a href="/profile" class="dropdown-menu-item">
                        <i class="fas fa-user"></i>
                        <span>الملف الشخصي</span>
                    </a>

                    <a href="/settings" class="dropdown-menu-item">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </a>

                    <a href="/notifications" class="dropdown-menu-item">
                        <i class="fas fa-bell"></i>
                        <span>الإشعارات</span>
                    </a>

                    <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid rgba(226, 232, 240, 0.8);">

                    <button class="dropdown-menu-item danger" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <nav class="modern-sidebar" id="sidebar" role="navigation">
        <div class="sidebar-brand">
            <svg viewBox="0 0 226 314" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g clip-path="url(#clip0_2311_2)">
                    <path
                        d="M222.67 242.4C222.12 242.34 217.25 235.37 215.69 233.82C202.05 220.28 177.14 219.92 159.86 225.41C149.37 228.74 140.73 233.2 136.92 244.19C147.26 244.32 158.57 241.07 168.89 241.88C170.36 242 176.59 243.02 176.49 244.82C176.47 245.16 172.12 245.53 169.99 246.96C160.84 253.09 160.13 266.77 156.21 276.38C147.17 298.52 136.12 302.03 113.78 302.57C111.49 302.63 96.8599 302.97 96.2899 302.3C95.4699 301.33 105.6 282.56 106.87 279.27C110.3 270.4 113.17 259.84 114.94 250.53C112.4 253.15 108.03 251.89 105.92 254.92C100.98 280.78 88.8799 319.26 55.4199 313.23C59.6299 308.26 64.4799 304.38 68.5899 299.24C73.7799 292.74 77.8799 284.83 81.2199 277.26L86.1799 261.54C83.6099 263.47 74.7199 266.14 73.2599 268.07C71.3199 270.63 70.6899 280.54 68.3299 284.18C63.4899 291.67 57.0699 289.94 49.8599 291.84C41.5899 294.01 32.5299 298.36 24.0199 299.07C18.3099 299.55 10.4399 297.61 4.65991 296.77C6.55991 295.07 8.87991 295.84 11.1599 294.52C18.3399 290.36 22.3599 275.68 24.8699 267.7C25.9099 264.39 26.1099 259.75 27.2999 256.28C36.5199 233.8 62.3199 241.46 81.3999 240.56C79.2899 249.02 75.2199 257.36 74.8199 266.12C77.7099 263.09 85.0099 261.91 87.0099 258.76C88.2399 252.27 90.6799 244.71 90.7499 238.21C90.7699 236.8 88.8999 235.79 91.1799 235.06C93.6999 234.26 103.82 234.26 107.17 234.22C108.61 234.2 112.61 232.4 111.05 235.63C108.82 240.26 108.06 247.06 107.23 252.17C109.07 250.29 114.82 250.96 116.07 249.41C116.73 248.59 116.56 246.56 117.24 245.34C121.22 238.21 125.47 233.69 132.33 229.06C125.11 228.24 117.27 230.38 109.99 231.07C87.1799 233.24 48.0499 236.21 29.2499 221.53C19.1099 213.61 13.8199 203.83 10.0299 191.77C9.60991 190.42 8.14991 187.26 9.35991 186.28C29.9799 222.47 73.5699 216.94 108.63 213.22C141.34 209.75 186.72 195.54 212.78 222.49C215.14 224.93 224.08 235.67 225.05 238.07C225.77 239.86 223.68 242.51 222.68 242.4H222.67ZM119.18 295.24C128.23 297.31 131.67 286.59 134.35 279.8C136.47 274.43 137.36 267.96 139.28 262.82C141.43 257.06 144.77 251.66 147.54 246.21C144.73 245.69 138.4 246.1 136.73 248.29C131.14 263.96 127.48 280.74 119.17 295.25L119.18 295.24ZM33.5999 291.63C36.5599 292.91 47.6599 288.15 48.8899 286.28C49.8699 281.26 61.2099 247.4 59.9399 245.71C59.1699 244.68 56.6699 246.16 55.6599 246.83C40.7299 256.79 48.3699 280.95 33.5999 291.62V291.63Z"
                        fill="white" />
                    <path
                        d="M7.81982 252.68C13.8098 250.4 10.4198 237.81 11.9098 235.99C12.7098 235.01 25.4498 233.78 26.1498 234.3C28.1998 235.81 26.7898 247.54 24.3498 249.97C21.3798 252.93 11.8498 253.85 7.81982 252.68Z"
                        fill="rgba(255, 255, 255, 0.8)" />
                    <path
                        d="M19.3199 255.58C13.3299 257.86 16.7199 270.45 15.2299 272.27C14.4299 273.25 1.68989 274.48 0.989891 273.96C-1.06011 272.45 0.349891 260.72 2.78989 258.29C5.75989 255.33 15.2899 254.41 19.3199 255.58Z"
                        fill="rgba(255, 255, 255, 0.8)" />
                    <path
                        d="M183.28 258.91L186.13 252.14C187.14 249.94 185.52 240.72 186.74 239.78C187.34 239.32 201.32 238.25 201.77 238.85C202.12 239.31 201.84 249.22 201.41 250.49C198.56 259 189.51 256.08 183.28 258.91Z"
                        fill="rgba(255, 255, 255, 0.8)" />
                    <path
                        d="M18.0701 94.52C18.0701 42.32 60.3901 0 112.59 0C164.79 0 207.11 42.32 207.11 94.52C207.11 124.4 193.24 151.04 171.59 168.37C188.53 152.57 199.13 130.05 199.13 105.06C199.13 57.26 160.38 18.52 112.59 18.52C64.8001 18.52 26.0501 57.26 26.0501 105.06C26.0501 130.05 36.6501 152.57 53.5901 168.37C31.9401 151.05 18.0701 124.41 18.0701 94.52Z"
                        fill="white" />
                    <path
                        d="M84.82 211.68V202.96C84.82 201.56 85.96 200.43 87.35 200.43H92.97V191.42L64.43 162.93C62.32 160.83 61.14 157.98 61.14 155V144.77L59.97 144.42C53.08 142.36 48.63 135.8 49.37 128.44C50.06 121.6 55.57 115.98 62.39 115.12C71.53 113.98 79.34 121.11 79.34 130.03C79.34 136.72 75.05 142.5 68.67 144.42L67.5 144.77V153.76C67.5 155.84 68.33 157.84 69.8 159.31L99.33 188.78V200.43H109.4V138.71C109.4 136.59 108.56 134.57 107.06 133.07L92.29 118.32V60.96L91.12 60.61C84.23 58.55 79.78 51.98 80.52 44.62C81.21 37.78 86.73 32.16 93.55 31.31C102.69 30.18 110.49 37.3 110.49 46.22C110.49 52.91 106.2 58.69 99.82 60.61L98.65 60.96V115.68L113.32 130.32C114.89 131.88 115.77 134 115.77 136.22V167.74L126.51 157.02V102.3L125.34 101.95C118.45 99.88 114.01 93.32 114.75 85.96C115.44 79.12 120.96 73.5 127.78 72.66C136.91 71.53 144.72 78.65 144.72 87.57C144.72 94.27 140.43 100.05 134.05 101.96L132.88 102.31V159.67L115.77 176.75V200.45H125.84V188.8L157.67 157.03V144.79L156.5 144.44C149.61 142.38 145.17 135.81 145.91 128.45C146.6 121.61 152.12 115.99 158.94 115.14C168.08 114 175.88 121.13 175.88 130.05C175.88 136.74 171.59 142.53 165.2 144.44L164.03 144.79V159.67L132.2 191.44V200.45H137.14C138.91 200.45 140.35 201.89 140.35 203.66V206.71C121.42 209.21 102.32 211.17 84.8 211.7L84.82 211.68ZM67.02 120.46C59.48 118.46 52.75 125.18 54.76 132.72C55.64 136.03 58.32 138.71 61.63 139.59C69.17 141.59 75.89 134.87 73.89 127.33C73.01 124.02 70.33 121.34 67.02 120.46ZM132.42 77.99C124.87 75.98 118.14 82.71 120.15 90.26C121.03 93.57 123.71 96.25 127.02 97.12C134.56 99.12 141.28 92.4 139.28 84.86C138.4 81.55 135.73 78.87 132.42 77.99Z"
                        fill="rgba(255, 255, 255, 0.9)" />
                </g>
                <defs>
                    <clipPath id="clip0_2311_2">
                        <rect width="225.18" height="313.86" fill="white" />
                    </clipPath>
                </defs>
            </svg>
            <div class="brand-text">
                <div class="brand-title">فكرة للبرمجيات</div>
                <div class="brand-subtitle">نظام إدارة متكامل</div>
            </div>
        </div>

        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">الرئيسية</div>
                <div class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <i class="nav-icon fas fa-chart-pie"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">إدارة المشاريع</div>
                <div class="nav-item">
                    <a href="/projects" class="nav-link">
                        <i class="nav-icon fas fa-briefcase"></i>
                        <span>المشاريع</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/tasks" class="nav-link">
                        <i class="nav-icon fas fa-check-square"></i>
                        <span>المهام</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">إدارة الموارد</div>
                <div class="nav-item">
                    <a href="/employees" class="nav-link">
                        <i class="nav-icon fas fa-user-tie"></i>
                        <span>الموظفين</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/clients" class="nav-link">
                        <i class="nav-icon fas fa-users-cog"></i>
                        <span>العملاء</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/subscriptions" class="nav-link">
                        <i class="nav-icon fas fa-credit-card"></i>
                        <span>الاشتراكات</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">التقارير</div>
                <div class="nav-item">
                    <a href="/reports" class="nav-link">
                        <i class="nav-icon fas fa-chart-area"></i>
                        <span>التقارير</span>
                    </a>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">النظام</div>
                <div class="nav-item">
                    <div class="nav-link" onclick="logout()">
                        <i class="nav-icon fas fa-power-off"></i>
                        <span>تسجيل الخروج</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- LOCAL JAVASCRIPT RESOURCES FIRST (Essential) -->
    <script src="/static/bootstrap-fallback.js"></script>
    <script src="/static/offline-detector.js"></script>

    <!-- CDN JavaScript (Enhancement only) - Load asynchronously -->
    <script>
        // Load Bootstrap JS enhancement if possible
        loadCDNResource('https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js', 'js',
            'https://unpkg.com/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js');
    </script>

    <script>
        const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', function () {
            const mobileToggle = document.getElementById('mobileMenuToggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');

            // Set active navigation link based on current page
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link[href]');

            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });

            // Enhanced icon hover effects
            const iconElements = document.querySelectorAll('.nav-icon, .stat-icon i, .quick-action-icon i');
            iconElements.forEach(icon => {
                icon.addEventListener('mouseenter', function () {
                    this.style.transform = 'scale(1.2) rotate(5deg)';
                });

                icon.addEventListener('mouseleave', function () {
                    this.style.transform = 'scale(1) rotate(0deg)';
                });
            });

            mobileToggle.addEventListener('click', function (e) {
                e.preventDefault();
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');
                document.body.style.overflow = sidebar.classList.contains('show') ? 'hidden' : '';
            });

            overlay.addEventListener('click', function () {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                document.body.style.overflow = '';
            });

            // Mobile Navigation Fix - IMPROVED
            document.querySelectorAll('.nav-link[href]').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const href = this.getAttribute('href');

                    // Check if it's a valid navigation link
                    if (!href || href === '#' || href === '') {
                        return;
                    }

                    // Add visual feedback
                    this.style.backgroundColor = 'rgba(102, 126, 234, 0.5)';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 200);

                    // Close mobile menu if open
                    if (sidebar.classList.contains('show')) {
                        sidebar.classList.remove('show');
                        overlay.classList.remove('show');
                        document.body.style.overflow = '';

                        // Wait for animation to complete before navigation
                        setTimeout(() => {
                            window.location.href = href;
                        }, 300);
                    } else {
                        // Navigate immediately if sidebar is not open
                        window.location.href = href;
                    }
                });

                // Add touch support for better mobile experience
                link.addEventListener('touchend', function (e) {
                    e.preventDefault();
                    this.click();
                });
            });

            // Also handle clicks on nav-link without href attribute (like logout)
            document.querySelectorAll('.nav-link:not([href])').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Add visual feedback
                    this.style.backgroundColor = 'rgba(102, 126, 234, 0.5)';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 200);

                    // Close mobile menu if open
                    if (sidebar.classList.contains('show')) {
                        sidebar.classList.remove('show');
                        overlay.classList.remove('show');
                        document.body.style.overflow = '';
                    }

                    // Execute the onclick function if it exists
                    if (this.getAttribute('onclick')) {
                        setTimeout(() => {
                            eval(this.getAttribute('onclick'));
                        }, 100);
                    }
                });

                // Add touch support for better mobile experience
                link.addEventListener('touchend', function (e) {
                    e.preventDefault();
                    this.click();
                });
            });

            window.addEventListener('resize', function () {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show');
                    overlay.classList.remove('show');
                    document.body.style.overflow = '';
                }
            });

            if (token) {
                loadUserProfile();
            }
        });

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/v1/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    updateUserDisplay();
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        function updateUserDisplay() {
            if (currentUser) {
                const avatar = document.getElementById('userAvatar');
                const userName = document.getElementById('userName');
                const dropdownUserName = document.getElementById('dropdownUserName');
                const dropdownUserRole = document.getElementById('dropdownUserRole');
                const dropdownUserEmail = document.getElementById('dropdownUserEmail');

                if (avatar && currentUser.first_name) {
                    avatar.textContent = currentUser.first_name.charAt(0).toUpperCase();
                }

                if (userName) {
                    userName.textContent = currentUser.first_name || 'المدير';
                }

                // Update dropdown info
                if (dropdownUserName) {
                    dropdownUserName.textContent = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || 'المدير';
                }

                if (dropdownUserRole) {
                    dropdownUserRole.textContent = getRoleDisplayName(currentUser.role || 'admin');
                }

                if (dropdownUserEmail) {
                    dropdownUserEmail.textContent = currentUser.email || 'admin@company.com';
                }
            }
        }

        function getRoleDisplayName(role) {
            const roles = {
                'admin': 'مدير النظام',
                'manager': 'مدير',
                'employee': 'موظف',
                'client': 'عميل'
            };
            return roles[role] || 'مستخدم';
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                // Clear all authentication data
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_data');
                sessionStorage.removeItem('access_token');
                sessionStorage.removeItem('refresh_token');
                sessionStorage.removeItem('user_data');
                localStorage.removeItem('token'); // Clear old token format too
                sessionStorage.removeItem('token');
                localStorage.removeItem('rememberMe');

                window.location.href = '/login';
            }
        }

        // User Menu Functions
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            const icon = document.getElementById('userMenuIcon');

            dropdown.classList.toggle('show');

            // Rotate the chevron icon
            if (dropdown.classList.contains('show')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', function (e) {
            const userMenu = document.querySelector('.user-menu-container');
            const dropdown = document.getElementById('userDropdown');
            const icon = document.getElementById('userMenuIcon');

            if (userMenu && !userMenu.contains(e.target)) {
                dropdown.classList.remove('show');
                if (icon) {
                    icon.style.transform = 'rotate(0deg)';
                }
            }
        });

        if (!token && !window.location.pathname.includes('login') && window.location.pathname !== '/') {
            window.location.href = '/';
        }
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>