{% extends "base_layout.html" %}

{% block title %}إدارة الموظفين - نظام ERP{% endblock %}
{% block page_title %}إدارة الموظفين{% endblock %}

{% block extra_css %}
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }

    .add-form {
        background: #fff;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 24px;
    }

    .form-control,
    .form-select {
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn {
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #007bff;
        border: none;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-1px);
    }

    .alert {
        border-radius: 8px;
        border: none;
        font-weight: 500;
    }

    .employees-list {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 24px;
    }

    .employee-item {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        transition: box-shadow 0.2s;
    }

    .employee-item:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .text-muted {
        color: #6c757d !important;
    }

    .employee-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #007bff;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        margin-right: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="h3 mb-0">إدارة الموظفين</h1>
        <p class="text-muted mb-0">إضافة وإدارة الموظفين بسهولة</p>
    </div>

    <!-- Add Employee Form -->
    <div class="add-form">
        <h5 class="mb-3">إضافة موظف جديد</h5>
        <form id="employeeForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">الاسم الأول *</label>
                    <input type="text" class="form-control" id="empFirstName" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">الاسم الأخير *</label>
                    <input type="text" class="form-control" id="empLastName" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">البريد الإلكتروني *</label>
                    <input type="email" class="form-control" id="empEmail" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">رقم الهاتف</label>
                    <input type="text" class="form-control" id="empPhone">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">المنصب *</label>
                    <input type="text" class="form-control" id="empPosition" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">القسم *</label>
                    <select class="form-select" id="empDepartment" required>
                        <option value="">اختر القسم</option>
                        <option value="development">التطوير</option>
                        <option value="design">التصميم</option>
                        <option value="marketing">التسويق</option>
                        <option value="sales">المبيعات</option>
                        <option value="hr">الموارد البشرية</option>
                        <option value="finance">المالية</option>
                        <option value="operations">العمليات</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">تاريخ التوظيف *</label>
                    <input type="date" class="form-control" id="empHireDate" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">كلمة المرور *</label>
                    <input type="password" class="form-control" id="empPassword" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-user-plus me-2"></i>إضافة الموظف
            </button>
            <div id="employeeMessage" class="mt-3"></div>
        </form>
    </div>

    <!-- Employees List -->
    <div class="employees-list">
        <h5 class="mb-3">قائمة الموظفين</h5>
        <div id="employeesList">
            <div class="text-center text-muted py-4">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>جاري تحميل الموظفين...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    console.log('🚀 Script loaded');

    const token = localStorage.getItem('access_token');
    console.log('🔑 Token:', token ? 'EXISTS' : 'MISSING');

    if (!token) {
        console.log('❌ No token, redirecting to login');
        alert('يرجى تسجيل الدخول أولاً');
        window.location.href = '/login';
    }

    document.addEventListener('DOMContentLoaded', function () {
        console.log('📄 DOM loaded');

        // Load employees
        loadEmployees();

        // Set default date
        setDefaultDate();

        // Add form event listener
        const form = document.getElementById('employeeForm');
        if (form) {
            console.log('📝 Form found, adding event listener');
            form.addEventListener('submit', function (e) {
                console.log('🔥 FORM SUBMITTED!');
                e.preventDefault();
                addEmployee();
            });
        } else {
            console.error('❌ Form not found!');
        }
    });

    function setDefaultDate() {
        console.log('📅 Setting default date');
        const dateInput = document.getElementById('empHireDate');
        if (dateInput) {
            dateInput.value = new Date().toISOString().split('T')[0];
            console.log('✅ Date set to:', dateInput.value);
        }
    }

    async function addEmployee() {
        console.log('🔄 addEmployee function called');

        const messageDiv = document.getElementById('employeeMessage');
        messageDiv.innerHTML = '<div class="alert alert-info">جاري إضافة الموظف...</div>';

        // Collect form data with logging
        const formData = {
            first_name: document.getElementById('empFirstName').value.trim(),
            last_name: document.getElementById('empLastName').value.trim(),
            email: document.getElementById('empEmail').value.trim(),
            phone: document.getElementById('empPhone').value.trim(),
            position: document.getElementById('empPosition').value.trim(),
            department: document.getElementById('empDepartment').value,
            hire_date: document.getElementById('empHireDate').value,
            password: document.getElementById('empPassword').value
        };

        console.log('📊 Form data collected:', formData);

        // Validation
        if (!formData.first_name || !formData.last_name || !formData.email ||
            !formData.position || !formData.department || !formData.hire_date || !formData.password) {
            console.log('❌ Validation failed');
            showMessage('يرجى ملء جميع الحقول المطلوبة', 'danger');
            return;
        }

        console.log('✅ Validation passed');
        console.log('🌐 About to make network request to /api/v1/employees/');
        console.log('🔑 Using token:', token ? token.substring(0, 50) + '...' : 'NONE');

        try {
            console.log('📡 Making fetch request...');

            const response = await fetch('/api/v1/employees/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            console.log('📥 Response received:', response.status, response.statusText);

            const result = await response.json();
            console.log('📄 Response data:', result);

            if (response.ok) {
                console.log('✅ Success!');
                showMessage('تم إضافة الموظف بنجاح!', 'success');
                document.getElementById('employeeForm').reset();
                setDefaultDate();
                setTimeout(loadEmployees, 1000);
            } else {
                console.log('❌ Error response:', response.status);
                if (response.status === 401) {
                    localStorage.removeItem('access_token');
                    alert('انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى');
                    window.location.href = '/login';
                } else {
                    showMessage(result.message || 'فشل في إضافة الموظف', 'danger');
                }
            }
        } catch (error) {
            console.error('💥 Network error:', error);
            showMessage('خطأ في الاتصال بالخادم', 'danger');
        }
    }

    async function loadEmployees() {
        console.log('📂 Loading employees...');
        try {
            const response = await fetch('/api/v1/employees/', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            console.log('📥 Load employees response:', response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('📄 Employees data:', data);
                displayEmployees(data.employees || data);
            } else if (response.status === 401) {
                localStorage.removeItem('access_token');
                alert('انتهت صلاحية الجلسة، يرجى تسجيل الدخول مرة أخرى');
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('💥 Error loading employees:', error);
        }
    }

    function displayEmployees(employees) {
        console.log('🎨 Displaying employees:', employees ? employees.length : 0);
        const container = document.getElementById('employeesList');

        if (!employees || employees.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <p>لا يوجد موظفين حالياً</p>
                </div>`;
            return;
        }

        container.innerHTML = employees.map(employee => `
            <div class="employee-item">
                <div class="d-flex align-items-center">
                    <div class="employee-avatar">
                        ${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${employee.first_name} ${employee.last_name}</h6>
                        <p class="text-muted mb-1">${employee.position}</p>
                        <small class="text-muted">${employee.email}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">${getDepartmentText(employee.department)}</span>
                        <br>
                        <small class="text-muted">منذ ${formatDate(employee.hire_date)}</small>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function showMessage(message, type) {
        console.log('💬 Showing message:', type, message);
        const messageDiv = document.getElementById('employeeMessage');
        messageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => messageDiv.innerHTML = '', 5000);
    }

    function formatDate(dateString) {
        return dateString ? new Date(dateString).toLocaleDateString('ar-SA') : 'غير محدد';
    }

    function getDepartmentText(department) {
        const departments = {
            'development': 'التطوير',
            'design': 'التصميم',
            'marketing': 'التسويق',
            'sales': 'المبيعات',
            'hr': 'الموارد البشرية',
            'finance': 'المالية',
            'operations': 'العمليات'
        };
        return departments[department] || department || 'غير محدد';
    }
</script>
{% endblock %}