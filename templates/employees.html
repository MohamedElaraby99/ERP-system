{% extends "base_layout.html" %}

{% block title %}إدارة الموظفين - نظام ERP{% endblock %}
{% block page_title %}إدارة الموظفين{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        --danger-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --glass-bg: rgba(255, 255, 255, 0.25);
        --glass-border: rgba(255, 255, 255, 0.18);
        --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    .page-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }

    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        box-shadow: var(--shadow-glass);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        border: 1px solid var(--glass-border);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        color: white;
        font-size: 1.5rem;
    }

    .employee-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .employee-card {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 2rem;
        border: 1px solid var(--glass-border);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .employee-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        background: var(--success-gradient);
    }

    .employee-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .employee-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--success-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0 auto 1rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    .btn-modern {
        background: var(--primary-gradient);
        border: none;
        border-radius: 15px;
        padding: 0.75rem 1.5rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .btn-modern::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transition: all 0.3s ease;
        transform: translate(-50%, -50%);
    }

    .btn-modern:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .btn-success-modern {
        background: var(--success-gradient);
    }

    .btn-warning-modern {
        background: var(--warning-gradient);
    }

    .btn-danger-modern {
        background: var(--danger-gradient);
    }

    .modal-content {
        background: var(--glass-bg);
        backdrop-filter: blur(15px);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
    }

    .form-control,
    .form-select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: #333;
        backdrop-filter: blur(10px);
    }

    .form-control:focus,
    .form-select:focus {
        background: rgba(255, 255, 255, 0.2);
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: white;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 4rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .alert-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
        border-radius: 15px;
        border: none;
        backdrop-filter: blur(10px);
        animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="text-white fw-bold mb-2">إدارة الموظفين 👥</h1>
                <p class="text-white-50">إدارة الفريق والمهام بكفاءة</p>
            </div>
            <div>
                <button class="btn btn-modern btn-success-modern me-2" onclick="openAddEmployeeModal()">
                    <i class="fas fa-user-plus me-2"></i>
                    إضافة موظف
                </button>
                <button class="btn btn-outline-light" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Search and Filters -->
        <div class="glass-card">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="searchInput" placeholder="🔍 البحث عن موظف..."
                        onkeyup="filterEmployees()">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="departmentFilter" onchange="filterEmployees()">
                        <option value="">جميع الأقسام</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="roleFilter" onchange="filterEmployees()">
                        <option value="">جميع الأدوار</option>
                        <option value="admin">مدير النظام</option>
                        <option value="manager">مدير</option>
                        <option value="employee">موظف</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-primary w-100" onclick="clearFilters()">
                        <i class="fas fa-times"></i> مسح
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingSpinner" class="loading-spinner" style="display: none;">
            <div class="spinner"></div>
        </div>

        <!-- Employees Grid -->
        <div id="employeesContainer" class="employee-grid">
            <!-- Employees will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="fas fa-users fa-4x mb-3"></i>
            <h3>لا يوجد موظفين حالياً</h3>
            <p>ابدأ بإضافة الموظفين لفريق العمل</p>
        </div>
    </div>
</div>

<!-- Add Employee Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: var(--success-gradient);">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    إضافة موظف جديد
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">الاسم الأول *</label>
                            <input type="text" class="form-control" id="firstName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">الاسم الأخير *</label>
                            <input type="text" class="form-control" id="lastName" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">البريد الإلكتروني *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">رقم الهاتف</label>
                            <input type="text" class="form-control" id="phone">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">المنصب *</label>
                            <input type="text" class="form-control" id="position" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">القسم *</label>
                            <select class="form-select" id="department" required>
                                <option value="">اختر القسم</option>
                                <option value="development">التطوير</option>
                                <option value="design">التصميم</option>
                                <option value="marketing">التسويق</option>
                                <option value="sales">المبيعات</option>
                                <option value="hr">الموارد البشرية</option>
                                <option value="finance">المالية</option>
                                <option value="operations">العمليات</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">الدور *</label>
                            <select class="form-select" id="role" required>
                                <option value="employee">موظف</option>
                                <option value="manager">مدير</option>
                                <option value="admin">مدير النظام</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">نوع التوظيف</label>
                            <select class="form-select" id="employmentType">
                                <option value="full_time">دوام كامل</option>
                                <option value="part_time">دوام جزئي</option>
                                <option value="contract">عقد</option>
                                <option value="intern">متدرب</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">الراتب</label>
                            <input type="number" class="form-control" id="salary" step="0.01">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">تاريخ التوظيف *</label>
                            <input type="date" class="form-control" id="hireDate" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">كلمة المرور *</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">المهارات</label>
                            <input type="text" class="form-control" id="skills" placeholder="مفصولة بفواصل">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-modern btn-success-modern" onclick="saveEmployee()">
                    <i class="fas fa-save me-2"></i>
                    حفظ الموظف
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Employee Details Modal -->
<div class="modal fade" id="employeeDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background: var(--primary-gradient);">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>
                    تفاصيل الموظف
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="employeeDetailsContent">
                <!-- Employee details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    const token = localStorage.getItem('access_token');
    let employees = [];
    let filteredEmployees = [];

    // Check authentication
    if (!token) {
        showAlert('يرجى تسجيل الدخول أولاً', 'warning');
        setTimeout(() => window.location.href = '/login', 2000);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 تهيئة صفحة الموظفين...');
        setDefaultDate();
        loadStatistics();
        loadEmployees();
        loadDepartments();
    });

    // Set default hire date
    function setDefaultDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('hireDate').value = today;
    }

    // Show loading
    function showLoading() {
        document.getElementById('loadingSpinner').style.display = 'flex';
        document.getElementById('employeesContainer').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
    }

    // Hide loading
    function hideLoading() {
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('employeesContainer').style.display = 'grid';
    }

    // Load statistics
    async function loadStatistics() {
        try {
            const response = await fetch('/api/v1/employees/statistics', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayStatistics(data.statistics);
            }
        } catch (error) {
            console.error('خطأ في تحميل الإحصائيات:', error);
        }
    }

    // Display statistics
    function displayStatistics(stats) {
        const container = document.getElementById('statsContainer');
        container.innerHTML = `
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="text-white mb-1">${stats.total_employees}</h3>
                <p class="text-white-50 mb-0">إجمالي الموظفين</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--success-gradient);">
                    <i class="fas fa-building"></i>
                </div>
                <h3 class="text-white mb-1">${stats.total_departments}</h3>
                <p class="text-white-50 mb-0">الأقسام</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--warning-gradient);">
                    <i class="fas fa-user-plus"></i>
                </div>
                <h3 class="text-white mb-1">${stats.recent_hires}</h3>
                <p class="text-white-50 mb-0">توظيف حديث</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: var(--danger-gradient);">
                    <i class="fas fa-star"></i>
                </div>
                <h3 class="text-white mb-1">${stats.average_performance.toFixed(1)}</h3>
                <p class="text-white-50 mb-0">متوسط الأداء</p>
            </div>
        `;
    }

    // Load employees
    async function loadEmployees() {
        try {
            showLoading();
            console.log('📥 جاري تحميل الموظفين...');

            const response = await fetch('/api/v1/employees', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                employees = data.employees || [];
                filteredEmployees = employees;
                displayEmployees(employees);
                console.log('✅ تم تحميل الموظفين بنجاح');
            } else {
                throw new Error('فشل في تحميل الموظفين');
            }
        } catch (error) {
            console.error('❌ خطأ في تحميل الموظفين:', error);
            showAlert('حدث خطأ في تحميل الموظفين', 'danger');
        } finally {
            hideLoading();
        }
    }

    // Display employees
    function displayEmployees(employeeList) {
        const container = document.getElementById('employeesContainer');
        const emptyState = document.getElementById('emptyState');

        if (!employeeList || employeeList.length === 0) {
            container.style.display = 'none';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';
        container.style.display = 'grid';

        container.innerHTML = employeeList.map(employee => `
            <div class="employee-card">
                <div class="employee-avatar">
                    ${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}
                </div>
                <div class="text-center mb-3">
                    <h5 class="text-white fw-bold mb-1">${employee.first_name} ${employee.last_name}</h5>
                    <p class="text-white-50 mb-1">${employee.position}</p>
                    <small class="text-white-50">${getDepartmentText(employee.department)}</small>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-white-50">البريد:</span>
                        <span class="text-white">${employee.email}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-white-50">الدور:</span>
                        <span class="badge ${getRoleBadgeClass(employee.role)}">${getRoleText(employee.role)}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="text-white-50">التوظيف:</span>
                        <span class="text-white">${formatDate(employee.hire_date)}</span>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-light flex-fill" onclick="viewEmployeeDetails(${employee.id})">
                        <i class="fas fa-eye"></i> تفاصيل
                    </button>
                    <button class="btn btn-sm btn-outline-primary flex-fill" onclick="viewEmployeeTasks(${employee.id})">
                        <i class="fas fa-tasks"></i> المهام
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteEmployee(${employee.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // Load departments for filter
    async function loadDepartments() {
        try {
            const response = await fetch('/api/v1/employees/departments', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                const select = document.getElementById('departmentFilter');

                data.departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.name;
                    option.textContent = `${getDepartmentText(dept.name)} (${dept.employee_count})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('خطأ في تحميل الأقسام:', error);
        }
    }

    // Filter employees
    function filterEmployees() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const department = document.getElementById('departmentFilter').value;
        const role = document.getElementById('roleFilter').value;

        filteredEmployees = employees.filter(employee => {
            const matchesSearch = !search ||
                employee.first_name.toLowerCase().includes(search) ||
                employee.last_name.toLowerCase().includes(search) ||
                employee.email.toLowerCase().includes(search) ||
                employee.position.toLowerCase().includes(search);

            const matchesDepartment = !department || employee.department === department;
            const matchesRole = !role || employee.role === role;

            return matchesSearch && matchesDepartment && matchesRole;
        });

        displayEmployees(filteredEmployees);
    }

    // Clear filters
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('departmentFilter').value = '';
        document.getElementById('roleFilter').value = '';
        filteredEmployees = employees;
        displayEmployees(employees);
    }

    // Open add employee modal
    function openAddEmployeeModal() {
        document.getElementById('employeeForm').reset();
        setDefaultDate();
        new bootstrap.Modal(document.getElementById('addEmployeeModal')).show();
    }

    // Save employee
    async function saveEmployee() {
        try {
            console.log('💾 جاري حفظ الموظف...');

            // Validate form
            const form = document.getElementById('employeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const employeeData = {
                first_name: document.getElementById('firstName').value.trim(),
                last_name: document.getElementById('lastName').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                position: document.getElementById('position').value.trim(),
                department: document.getElementById('department').value,
                role: document.getElementById('role').value,
                employment_type: document.getElementById('employmentType').value,
                salary: parseFloat(document.getElementById('salary').value) || null,
                hire_date: document.getElementById('hireDate').value,
                password: document.getElementById('password').value,
                skills: document.getElementById('skills').value.trim()
            };

            console.log('📤 بيانات الموظف:', employeeData);

            const response = await fetch('/api/v1/employees', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(employeeData)
            });

            const result = await response.json();

            if (response.ok) {
                showAlert('تم إضافة الموظف بنجاح! ✅', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addEmployeeModal')).hide();
                loadEmployees();
                loadStatistics();
            } else {
                throw new Error(result.message || 'فشل في إضافة الموظف');
            }
        } catch (error) {
            console.error('❌ خطأ في حفظ الموظف:', error);
            showAlert(error.message || 'حدث خطأ في حفظ الموظف', 'danger');
        }
    }

    // View employee details
    async function viewEmployeeDetails(employeeId) {
        try {
            console.log(`👁️ عرض تفاصيل الموظف ${employeeId}`);

            const response = await fetch(`/api/v1/employees/${employeeId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                displayEmployeeDetails(data.employee);
            } else {
                throw new Error('فشل في تحميل تفاصيل الموظف');
            }
        } catch (error) {
            console.error('❌ خطأ في عرض التفاصيل:', error);
            showAlert('حدث خطأ في تحميل التفاصيل', 'danger');
        }
    }

    // Display employee details
    function displayEmployeeDetails(employee) {
        const content = document.getElementById('employeeDetailsContent');
        content.innerHTML = `
            <div class="text-center mb-4">
                <div class="employee-avatar mx-auto mb-3">
                    ${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}
                </div>
                <h4>${employee.first_name} ${employee.last_name}</h4>
                <p class="text-muted">${employee.position}</p>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong>البريد الإلكتروني:</strong><br>
                    ${employee.email}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>الهاتف:</strong><br>
                    ${employee.phone || 'غير محدد'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>القسم:</strong><br>
                    ${getDepartmentText(employee.department)}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>الدور:</strong><br>
                    ${getRoleText(employee.role)}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>تاريخ التوظيف:</strong><br>
                    ${formatDate(employee.hire_date)}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>الراتب:</strong><br>
                    ${employee.salary ? formatCurrency(employee.salary) : 'غير محدد'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>المهام المكتملة:</strong><br>
                    ${employee.completed_tasks || 0}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>إجمالي المهام:</strong><br>
                    ${employee.total_tasks || 0}
                </div>
            </div>
            ${employee.skills ? `
                <div class="mt-3">
                    <strong>المهارات:</strong><br>
                    <div class="mt-2">
                        ${employee.skills.map ? employee.skills.map(skill =>
            `<span class="badge bg-primary me-1">${skill}</span>`
        ).join('') : employee.skills.split(',').map(skill =>
            `<span class="badge bg-primary me-1">${skill.trim()}</span>`
        ).join('')}
                    </div>
                </div>
            ` : ''}
        `;

        new bootstrap.Modal(document.getElementById('employeeDetailsModal')).show();
    }

    // View employee tasks
    async function viewEmployeeTasks(employeeId) {
        try {
            console.log(`📋 عرض مهام الموظف ${employeeId}`);

            const response = await fetch(`/api/v1/employees/${employeeId}/tasks`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.tasks && data.tasks.length > 0) {
                    // Redirect to tasks page with employee filter
                    window.location.href = `/tasks?employee=${employeeId}`;
                } else {
                    showAlert(`لا توجد مهام مخصصة للموظف ${data.employee.first_name} ${data.employee.last_name}`, 'info');
                }
            } else {
                throw new Error('فشل في تحميل المهام');
            }
        } catch (error) {
            console.error('❌ خطأ في عرض المهام:', error);
            showAlert('حدث خطأ في تحميل المهام', 'danger');
        }
    }

    // Delete employee
    async function deleteEmployee(employeeId) {
        if (!confirm('هل أنت متأكد من حذف هذا الموظف؟\nسيتم حذف حساب المستخدم المرتبط أيضاً.')) {
            return;
        }

        try {
            console.log(`🗑️ حذف الموظف ${employeeId}`);

            const response = await fetch(`/api/v1/employees/${employeeId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                showAlert('تم حذف الموظف بنجاح! 🗑️', 'success');
                loadEmployees();
                loadStatistics();
            } else {
                const result = await response.json();
                throw new Error(result.message || 'فشل في حذف الموظف');
            }
        } catch (error) {
            console.error('❌ خطأ في حذف الموظف:', error);
            showAlert(error.message || 'حدث خطأ في حذف الموظف', 'danger');
        }
    }

    // Refresh data
    function refreshData() {
        loadStatistics();
        loadEmployees();
        showAlert('تم تحديث البيانات! 🔄', 'success');
    }

    // Helper functions
    function getDepartmentText(department) {
        const departments = {
            'development': 'التطوير',
            'design': 'التصميم',
            'marketing': 'التسويق',
            'sales': 'المبيعات',
            'hr': 'الموارد البشرية',
            'finance': 'المالية',
            'operations': 'العمليات'
        };
        return departments[department] || department || 'غير محدد';
    }

    function getRoleText(role) {
        const roles = {
            'admin': 'مدير النظام',
            'manager': 'مدير',
            'employee': 'موظف'
        };
        return roles[role] || role;
    }

    function getRoleBadgeClass(role) {
        const classes = {
            'admin': 'bg-danger',
            'manager': 'bg-warning',
            'employee': 'bg-success'
        };
        return classes[role] || 'bg-secondary';
    }

    function formatDate(dateString) {
        if (!dateString) return 'غير محدد';
        return new Date(dateString).toLocaleDateString('ar-SA');
    }

    function formatCurrency(amount) {
        if (!amount) return '0 ر.س';
        return new Intl.NumberFormat('ar-SA', {
            style: 'currency',
            currency: 'SAR'
        }).format(amount);
    }

    // Show alert function
    function showAlert(message, type = 'info') {
        // Remove existing alerts
        document.querySelectorAll('.alert-toast').forEach(alert => alert.remove());

        // Create alert
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-toast`;
        alert.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas ${getAlertIcon(type)} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;

        document.body.appendChild(alert);

        // Auto remove
        setTimeout(() => {
            if (alert.parentElement) {
                alert.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => alert.remove(), 300);
            }
        }, 5000);
    }

    function getAlertIcon(type) {
        const icons = {
            'success': 'fa-check-circle',
            'danger': 'fa-exclamation-circle',
            'warning': 'fa-exclamation-triangle',
            'info': 'fa-info-circle'
        };
        return icons[type] || 'fa-info-circle';
    }
</script>
{% endblock %}