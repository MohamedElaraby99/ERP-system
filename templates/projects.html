{% extends "base_layout.html" %}

{% block title %}Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ - Ù†Ø¸Ø§Ù… ERP{% endblock %}
{% block page_title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹{% endblock %}

{% block extra_css %}
<style>
    :root {
        --project-subscription: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --project-onetime: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        --project-completed: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        --project-cancelled: linear-gradient(135deg, #ed64a6 0%, #d53f8c 100%);
    }

    .project-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
        line-height: 1;
    }

    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .project-card {
        background: white;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .project-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .project-type-badge {
        position: absolute;
        top: 1rem;
        left: 1rem;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .type-subscription {
        background: var(--project-subscription);
    }

    .type-onetime {
        background: var(--project-onetime);
    }

    .project-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        position: relative;
    }

    .project-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }

    .project-body {
        padding: 1.5rem;
    }

    .revenue-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .revenue-card {
        padding: 1rem;
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        border-radius: 8px;
        border: 1px solid rgba(102, 126, 234, 0.1);
        text-align: center;
    }

    .revenue-label {
        font-size: 0.75rem;
        color: #64748b;
        margin-bottom: 0.25rem;
    }

    .revenue-amount {
        font-size: 1.1rem;
        font-weight: 700;
        color: #667eea;
    }

    .project-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        padding: 1rem 1.5rem;
        background: rgba(248, 250, 252, 0.5);
        border-top: 1px solid rgba(226, 232, 240, 0.5);
    }

    .btn-action {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        border: none;
        transition: all 0.3s ease;
        cursor: pointer;
        color: white;
    }

    .btn-primary {
        background: var(--primary-gradient);
    }

    .btn-success {
        background: var(--project-onetime);
    }

    .btn-warning {
        background: var(--warning-gradient);
    }

    .btn-danger {
        background: var(--project-cancelled);
    }

    .filters-section {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .tech-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .tech-tag {
        padding: 0.25rem 0.75rem;
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .modal-content {
        border: none;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .form-control,
    .form-select {
        border-radius: 8px;
        border: 1px solid rgba(226, 232, 240, 0.8);
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 3rem;
        color: #667eea;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    .empty-state i {
        font-size: 4rem;
        color: #cbd5e0;
        margin-bottom: 1rem;
    }

    .empty-state h4 {
        color: #718096;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #a0aec0;
        margin-bottom: 2rem;
    }

    /* Form Sections Styling */
    .form-section {
        background: rgba(102, 126, 234, 0.02);
        border: 1px solid rgba(102, 126, 234, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .form-section:hover {
        border-color: rgba(102, 126, 234, 0.2);
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
    }

    .section-header {
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid rgba(102, 126, 234, 0.1);
    }

    .section-title {
        color: #667eea;
        font-weight: 600;
        margin: 0;
        font-size: 1.1rem;
    }

    .modern-input {
        border: 2px solid rgba(226, 232, 240, 0.8);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        background: white;
    }

    .modern-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
        background: rgba(102, 126, 234, 0.02);
    }

    .input-group-text {
        background: var(--primary-gradient);
        color: white;
        border: none;
        font-weight: 600;
    }

    /* Subscriber Management */
    .subscriber-item {
        background: white;
        border: 2px solid rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .subscriber-item:hover {
        border-color: rgba(102, 126, 234, 0.3);
        transform: translateY(-2px);
    }

    .subscriber-info {
        flex: 1;
    }

    .subscriber-name {
        font-weight: 600;
        color: #1a202c;
        margin-bottom: 0.25rem;
    }

    .subscriber-email {
        color: #64748b;
        font-size: 0.875rem;
    }

    .subscriber-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Revenue Preview */
    .revenue-preview .alert,
    .payment-preview .alert {
        border: none;
        border-radius: 8px;
        font-weight: 500;
    }

    .revenue-preview .alert-info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
        border-left: 4px solid #3b82f6;
    }

    .payment-preview .alert-success {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(21, 128, 61, 0.1) 100%);
        border-left: 4px solid #22c55e;
    }

    .payment-preview .alert-warning {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
        border-left: 4px solid #fbbf24;
    }

    /* Add Client Form */
    .client-form-inline {
        background: rgba(34, 197, 94, 0.05);
        border: 2px dashed rgba(34, 197, 94, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }

    .client-form-inline.show {
        display: block;
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Button Improvements */
    .btn-outline-primary:hover,
    .btn-outline-success:hover,
    .btn-outline-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 768px) {
        .project-stats {
            grid-template-columns: 1fr;
        }

        .revenue-info {
            grid-template-columns: 1fr;
        }

        .project-actions {
            flex-wrap: wrap;
        }

        .btn-action {
            flex: 1;
            min-width: 120px;
        }

        .form-section {
            padding: 1rem;
        }

        .payment-preview .row {
            flex-direction: column;
        }
    }

    /* Subscribers Modal Styles */
    .subscription-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 15px;
        padding: 2rem;
        border: 1px solid #dee2e6;
    }

    .summary-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 1rem;
    }

    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .summary-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        margin: 0 auto 1rem;
    }

    .summary-number {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 0.5rem;
    }

    .summary-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .subscribers-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        border: 1px solid #e9ecef;
    }

    .section-title {
        color: #2c3e50;
        font-weight: 600;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 0.5rem;
    }

    .subscriber-card {
        display: flex;
        align-items: center;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }

    .subscriber-card:hover {
        background: white;
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
        transform: translateY(-2px);
    }

    .subscriber-avatar {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        margin-right: 1rem;
    }

    .subscriber-details {
        flex-grow: 1;
    }

    .subscriber-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .subscriber-type {
        margin-bottom: 0.5rem;
    }

    .subscriber-contact {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .contact-item {
        display: flex;
        align-items: center;
        color: #6c757d;
        font-size: 0.9rem;
    }

    .contact-item i {
        margin-right: 0.25rem;
        width: 15px;
    }

    .subscriber-actions {
        display: flex;
        gap: 0.5rem;
    }

    /* Client Selection Modal */
    .clients-list-container {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .client-selection-item {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .client-selection-item:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
    }

    .client-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #28a745, #20c997);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
    }

    .client-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }

    .client-details {
        font-size: 0.9rem;
    }

    /* Client Details Modal */
    .detail-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e9ecef;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-item label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0;
        min-width: 120px;
    }

    .detail-item span {
        color: #2c3e50;
        text-align: right;
    }

    /* Modern Confirmation Dialog */
    .confirm-icon {
        text-align: center;
    }

    /* Toast Notifications */
    .toast {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .toast-body {
        font-weight: 500;
    }

    /* Additional responsive styles for subscribers */
    @media (max-width: 768px) {
        .subscriber-card {
            flex-direction: column;
            text-align: center;
        }

        .subscriber-avatar {
            margin: 0 0 1rem 0;
        }

        .subscriber-contact {
            justify-content: center;
        }

        .subscriber-actions {
            margin-top: 1rem;
            justify-content: center;
        }

        .summary-card {
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="content-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-project-diagram me-2"></i>
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
        </h1>
        <p class="page-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ§Ù„Ø¯ÙØ¹ Ø§Ù„ÙƒØ§Ù…Ù„</p>
    </div>
    <div class="content-actions">
        <button class="btn btn-modern btn-primary-modern" data-bs-toggle="modal" data-bs-target="#addProjectModal">
            <i class="fas fa-plus me-2"></i>
            Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
        </button>
    </div>
</div>

<!-- Statistics -->
<div class="project-stats">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--project-subscription);">
                <i class="fas fa-sync-alt"></i>
            </div>
            <div class="stat-number" id="subscriptionCount">0</div>
        </div>
        <div class="stat-label">Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--project-onetime);">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-number" id="onetimeCount">0</div>
        </div>
        <div class="stat-label">Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙƒØ§Ù…Ù„</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--project-completed);">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-number" id="completedCount">0</div>
        </div>
        <div class="stat-label">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…ÙƒØªÙ…Ù„Ø©</div>
    </div>

    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--warning-gradient);">
                <i class="fas fa-coins"></i>
            </div>
            <div class="stat-number" id="monthlyRevenue">0</div>
        </div>
        <div class="stat-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø±.Ø³)</div>
    </div>
</div>

<!-- Filters -->
<div class="filters-section">
    <div class="row align-items-end">
        <div class="col-lg-2 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted fw-bold">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label>
            <select class="form-select" id="typeFilter">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                <option value="subscription">Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</option>
                <option value="onetime">Ø¯ÙØ¹ ÙƒØ§Ù…Ù„</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted fw-bold">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select class="form-select" id="statusFilter">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="active">Ù†Ø´Ø·</option>
                <option value="completed">Ù…ÙƒØªÙ…Ù„</option>
                <option value="on-hold">Ù…Ø¹Ù„Ù‚</option>
                <option value="cancelled">Ù…Ù„ØºÙŠ</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted fw-bold">Ø§Ù„ØªÙ‚Ù†ÙŠØ©</label>
            <select class="form-select" id="techFilter">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª</option>
                <option value="React">React</option>
                <option value="Vue">Vue</option>
                <option value="Laravel">Laravel</option>
                <option value="Node.js">Node.js</option>
            </select>
        </div>
        <div class="col-lg-4 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted fw-bold">Ø§Ù„Ø¨Ø­Ø«</label>
            <input type="text" class="form-control" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø£Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„...">
        </div>
        <div class="col-lg-2 col-md-12">
            <button class="btn btn-modern btn-primary-modern w-100" onclick="filterProjects()">
                <i class="fas fa-search me-2"></i>
                Ø¨Ø­Ø«
            </button>
        </div>
    </div>
</div>

<!-- Projects Grid - ONLY shows data from backend database -->
<div id="projectsGrid" class="row">
    <!-- Loading state -->
    <div id="loadingState" class="col-12" style="display: none;">
        <div class="loading-spinner">
            <div class="spinner-border text-primary me-3" role="status">
                <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>
            <h5 class="mb-0">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h5>
        </div>
    </div>

    <!-- Projects will be populated here by JavaScript from backend API -->
    <!-- No hardcoded examples - only real database data -->
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: var(--primary-gradient); color: white;">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>
                    Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <form id="addProjectForm">
                    <!-- Basic Information -->
                    <div class="form-section mb-4">
                        <div class="section-header">
                            <h6 class="section-title">
                                <i class="fas fa-info-circle me-2"></i>
                                Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-project-diagram me-1"></i>
                                    Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ *
                                </label>
                                <input type="text" class="form-control modern-input" id="projectName" required
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-tags me-1"></i>
                                    Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ *
                                </label>
                                <select class="form-select modern-input" id="projectType" required
                                    onchange="toggleProjectType()">
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</option>
                                    <option value="subscription">ğŸ’³ Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ</option>
                                    <option value="onetime">ğŸ’° Ø¯ÙØ¹ ÙƒØ§Ù…Ù„</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-align-left me-1"></i>
                                    ÙˆØµÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                                </label>
                                <textarea class="form-control modern-input" id="description" rows="3"
                                    placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ£Ù‡Ø¯Ø§ÙÙ‡..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Client Selection -->
                    <div class="form-section mb-4" id="clientSection">
                        <div class="section-header">
                            <h6 class="section-title">
                                <i class="fas fa-users me-2"></i>
                                Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-8 mb-3" id="onetimeClientDiv">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user-tie me-1"></i>
                                    Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø°Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„ÙƒØ§Ù…Ù„)
                                </label>
                                <select class="form-select modern-input" id="clientId">
                                    <option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3" id="addClientDiv">
                                <label class="form-label fw-bold text-transparent">.</label>
                                <button type="button" class="btn btn-outline-primary w-100"
                                    onclick="showAddClientForm()">
                                    <i class="fas fa-user-plus me-2"></i>
                                    Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                        </div>

                        <!-- Subscription Client Selection -->
                        <div id="subscriptionClientsDiv" style="display: none;">
                            <label class="form-label fw-bold">
                                <i class="fas fa-users-cog me-1"></i>
                                Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† (Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒÙŠØ©)
                            </label>
                            <div class="subscriber-list mb-3" id="subscribersList">
                                <!-- Dynamic subscriber list will be added here -->
                            </div>
                            <button type="button" class="btn btn-outline-success" onclick="addSubscriber()">
                                <i class="fas fa-plus me-2"></i>
                                Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ
                            </button>
                        </div>
                    </div>

                    <!-- Financial Information -->
                    <div class="form-section mb-4" id="financialSection">
                        <div class="section-header">
                            <h6 class="section-title">
                                <i class="fas fa-dollar-sign me-2"></i>
                                Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                            </h6>
                        </div>

                        <!-- For subscription projects -->
                        <div id="subscriptionFinancial" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ *
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control modern-input" id="monthlyPrice"
                                            step="0.01" placeholder="500.00">
                                        <span class="input-group-text">Ø±.Ø³</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-users me-1"></i>
                                        Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                                    </label>
                                    <input type="number" class="form-control modern-input" id="subscriberCount" min="0"
                                        value="0" placeholder="1">
                                    <div class="form-text">Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</div>
                                </div>
                            </div>
                            <div class="revenue-preview" id="subscriptionRevenue">
                                <div class="alert alert-info">
                                    <i class="fas fa-calculator me-2"></i>
                                    <strong>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</strong> <span id="expectedRevenue">0 Ø±.Ø³ Ø´Ù‡Ø±ÙŠØ§Ù‹</span>
                                </div>
                            </div>
                        </div>

                        <!-- For one-time projects -->
                        <div id="onetimeFinancial" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-money-bill me-1"></i>
                                        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº *
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control modern-input" id="totalAmount"
                                            step="0.01" placeholder="10000.00">
                                        <span class="input-group-text">Ø±.Ø³</span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-hand-holding-usd me-1"></i>
                                        Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹
                                    </label>
                                    <div class="input-group">
                                        <input type="number" class="form-control modern-input" id="paidAmount"
                                            step="0.01" value="0" placeholder="0.00">
                                        <span class="input-group-text">Ø±.Ø³</span>
                                    </div>
                                </div>
                            </div>
                            <div class="payment-preview" id="paymentInfo">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="alert alert-success">
                                            <strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> <span id="paidDisplay">0 Ø±.Ø³</span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="alert alert-warning">
                                            <strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> <span id="remainingDisplay">0 Ø±.Ø³</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Details -->
                    <div class="form-section mb-4">
                        <div class="section-header">
                            <h6 class="section-title">
                                <i class="fas fa-code me-2"></i>
                                Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ©
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-laptop-code me-1"></i>
                                    Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
                                </label>
                                <input type="text" class="form-control modern-input" id="technologies"
                                    placeholder="React, Node.js, MongoDB, Laravel...">
                                <div class="form-text">Ø§ÙØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø¨ÙØ§ØµÙ„Ø©</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-flag me-1"></i>
                                    Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ *
                                </label>
                                <select class="form-select modern-input" id="status" required>
                                    <option value="active">ğŸŸ¢ Ù†Ø´Ø·</option>
                                    <option value="planning">ğŸ“‹ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ®Ø·ÙŠØ·</option>
                                    <option value="on_hold">â¸ï¸ Ù…Ø¹Ù„Ù‚</option>
                                    <option value="completed">âœ… Ù…ÙƒØªÙ…Ù„</option>
                                    <option value="cancelled">âŒ Ù…Ù„ØºÙŠ</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-star me-1"></i>
                                    Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
                                </label>
                                <select class="form-select modern-input" id="priority">
                                    <option value="low">ğŸŸ¡ Ù…Ù†Ø®ÙØ¶Ø©</option>
                                    <option value="medium" selected>ğŸŸ  Ù…ØªÙˆØ³Ø·Ø©</option>
                                    <option value="high">ğŸ”´ Ø¹Ø§Ù„ÙŠØ©</option>
                                    <option value="urgent">âš¡ Ø¹Ø§Ø¬Ù„Ø©</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-layer-group me-1"></i>
                                    Ù†ÙˆØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                                </label>
                                <select class="form-select modern-input" id="category">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="web_app">ğŸŒ ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨</option>
                                    <option value="mobile_app">ğŸ“± ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ¨Ø§ÙŠÙ„</option>
                                    <option value="desktop_app">ğŸ’» ØªØ·Ø¨ÙŠÙ‚ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨</option>
                                    <option value="api">ğŸ”— API</option>
                                    <option value="website">ğŸ–¥ï¸ Ù…ÙˆÙ‚Ø¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-clock me-1"></i>
                                    Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©
                                </label>
                                <input type="number" class="form-control modern-input" id="estimatedHours"
                                    placeholder="160" min="1">
                            </div>
                        </div>
                    </div>

                    <!-- Dates & Project Manager -->
                    <div class="form-section mb-4">
                        <div class="section-header">
                            <h6 class="section-title">
                                <i class="fas fa-calendar-alt me-2"></i>
                                Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-play me-1"></i>
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *
                                </label>
                                <input type="date" class="form-control modern-input" id="startDate" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-stop me-1"></i>
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ *
                                </label>
                                <input type="date" class="form-control modern-input" id="endDate" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-user-tie me-1"></i>
                                    Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                                </label>
                                <select class="form-select modern-input" id="projectManagerId">
                                    <option value="">Ø§Ø®ØªØ± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Quick Add Client Form -->
                    <div class="client-form-inline" id="quickClientForm">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-user-plus me-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                        </h6>
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <select class="form-select" id="newClientType" onchange="toggleClientTypeFields()">
                                    <option value="individual">ÙØ±Ø¯</option>
                                    <option value="company">Ø´Ø±ÙƒØ©</option>
                                </select>
                            </div>
                            <div class="col-md-5 mb-2">
                                <input type="text" class="form-control" id="newClientName"
                                    placeholder="Ø§Ù„Ø§Ø³Ù…/Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©" required>
                            </div>
                            <div class="col-md-4 mb-2">
                                <input type="email" class="form-control" id="newClientEmail"
                                    placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <input type="text" class="form-control" id="newClientPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                            </div>
                            <div class="col-md-6 mb-2">
                                <input type="text" class="form-control" id="newClientCity" placeholder="Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©">
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-success btn-sm" onclick="saveNewClient()">
                                <i class="fas fa-check me-1"></i>
                                Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm"
                                onclick="hideAddClientForm()">
                                <i class="fas fa-times me-1"></i>
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                        </div>
                    </div>

                </form>
            </div>
            <div class="modal-footer" style="border: none; padding: 1rem 2rem 2rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-modern btn-primary-modern" onclick="addProject()">
                    <i class="fas fa-save me-2"></i>
                    Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let projects = [];
    let clients = [];
    let employees = [];
    let currentEditingProject = null;
    let projectSubscribers = [];

    // API configuration - WITH JWT AUTHENTICATION
    const API_BASE = '/api/v1';

    // JWT Token management
    function getAuthToken() {
        return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
    }

    function getAuthHeaders() {
        const token = getAuthToken();
        return {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
        };
    }

    function redirectToLogin() {
        const currentPath = window.location.pathname + window.location.search;
        window.location.href = `/login?return_to=${encodeURIComponent(currentPath)}`;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸš€ Projects page loaded - WITH JWT AUTHENTICATION');

        // Check if user is authenticated
        const token = getAuthToken();
        if (!token) {
            console.log('âŒ No authentication token found, redirecting to login');
            redirectToLogin();
            return;
        }

        // Load everything from backend
        loadAllData();

        // Set default dates for forms
        setDefaultDates();

        // Add event listeners
        addEventListeners();
    });

    // Load all data from backend
    async function loadAllData() {
        console.log('ğŸ“¡ Loading ALL data from Flask backend with JWT...');
        showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        try {
            await Promise.all([
                loadProjectsFromAPI(),
                loadStatisticsFromAPI(),
                loadClientsFromAPI(),
                loadEmployeesFromAPI()
            ]);
            console.log('âœ… ALL DATA LOADED FROM BACKEND WITH AUTH');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);

            // Check if it's an auth error
            if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                console.log('ğŸ” Authentication failed, redirecting to login');
                redirectToLogin();
                return;
            }

            displayEmptyState();
        } finally {
            hideLoading();
        }
    }

    // Load projects from API - WITH JWT
    async function loadProjectsFromAPI() {
        try {
            console.log('ğŸ“¡ GET /api/v1/projects with JWT');

            const response = await fetch('/api/v1/projects', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            console.log('ğŸ“¡ API Response:', response.status);

            if (response.status === 401) {
                throw new Error('401 Unauthorized');
            }

            if (response.ok) {
                const data = await response.json();
                console.log('ğŸ“‚ RAW DATA:', data);

                // Handle response
                projects = Array.isArray(data) ? data : (data.projects || []);

                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${projects.length} Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);
                displayProjectsFromDB(projects);

            } else {
                console.error('âŒ API Error:', response.status);
                throw new Error(`API Error: ${response.status}`);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ API:', error);
            throw error;
        }
    }

    // Load statistics from API - WITH JWT  
    async function loadStatisticsFromAPI() {
        try {
            console.log('ğŸ“Š GET /api/v1/projects/statistics with JWT');

            const response = await fetch('/api/v1/projects/statistics', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                throw new Error('401 Unauthorized');
            }

            if (response.ok) {
                const data = await response.json();
                console.log('ğŸ“Š Statistics from DB:', data);

                const stats = data.statistics || data;
                updateStatisticsDisplay(stats);
            } else {
                console.warn('âš ï¸ Statistics API failed');
                updateStatisticsDisplay({
                    subscription_projects: 0,
                    onetime_projects: 0,
                    completed_projects: 0,
                    monthly_revenue: 0
                });
            }
        } catch (error) {
            console.error('âŒ Statistics error:', error);
            if (error.message.includes('401')) {
                throw error;
            }
        }
    }

    // Load clients from API - WITH JWT
    async function loadClientsFromAPI() {
        try {
            console.log('ğŸ‘¥ GET /api/v1/clients with JWT');

            const response = await fetch('/api/v1/clients', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                throw new Error('401 Unauthorized');
            }

            if (response.ok) {
                const data = await response.json();
                clients = Array.isArray(data) ? data : (data.clients || []);
                console.log(`âœ… Loaded ${clients.length} clients`);
                populateClientSelect();
            } else {
                console.warn('âš ï¸ Clients API failed');
            }
        } catch (error) {
            console.error('âŒ Clients error:', error);
            if (error.message.includes('401')) {
                throw error;
            }
        }
    }

    // Load employees from API - WITH JWT
    async function loadEmployeesFromAPI() {
        try {
            console.log('ğŸ‘· GET /api/v1/employees with JWT');

            const response = await fetch('/api/v1/employees', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.status === 401) {
                throw new Error('401 Unauthorized');
            }

            if (response.ok) {
                const data = await response.json();
                employees = Array.isArray(data) ? data : (data.employees || []);
                console.log(`âœ… Loaded ${employees.length} employees`);
                populateManagerSelect();
            } else {
                console.warn('âš ï¸ Employees API failed');
            }
        } catch (error) {
            console.error('âŒ Employees error:', error);
            if (error.message.includes('401')) {
                throw error;
            }
        }
    }

    // Populate client select
    function populateClientSelect() {
        const clientSelect = document.getElementById('clientId');
        const currentValue = clientSelect.value;

        clientSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹</option>';

        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = `${client.display_name || client.name} - ${client.email}`;
            clientSelect.appendChild(option);
        });

        if (currentValue) {
            clientSelect.value = currentValue;
        }
    }

    // Populate manager select
    function populateManagerSelect() {
        const managerSelect = document.getElementById('projectManagerId');
        const currentValue = managerSelect.value;

        managerSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</option>';

        employees.forEach(employee => {
            const option = document.createElement('option');
            option.value = employee.id;
            option.textContent = `${employee.first_name} ${employee.last_name} - ${employee.position}`;
            managerSelect.appendChild(option);
        });

        if (currentValue) {
            managerSelect.value = currentValue;
        }
    }

    // Update statistics display
    function updateStatisticsDisplay(stats) {
        document.getElementById('subscriptionCount').textContent = stats.subscription_projects || 0;
        document.getElementById('onetimeCount').textContent = stats.onetime_projects || 0;
        document.getElementById('completedCount').textContent = stats.completed_projects || 0;
        document.getElementById('monthlyRevenue').textContent = Math.round(stats.monthly_revenue || 0).toLocaleString();

        console.log('ğŸ“Š Statistics updated in UI');
    }

    // Display projects from database
    function displayProjectsFromDB(projectsList) {
        const grid = document.getElementById('projectsGrid');

        console.log(`ğŸ–¼ï¸ Ø¹Ø±Ø¶ ${projectsList.length} Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

        if (projectsList.length === 0) {
            displayEmptyState();
            return;
        }

        grid.innerHTML = projectsList.map(project => createProjectCardHTML(project)).join('');
    }

    // Display empty state
    function displayEmptyState() {
        const grid = document.getElementById('projectsGrid');
        grid.innerHTML = `
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙŠØ¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                    <p class="text-muted">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</p>
                </div>
            </div>
        `;
    }

    // Create project card HTML
    function createProjectCardHTML(project) {
        const techTags = project.technologies ?
            project.technologies.split(',').map(tech =>
                `<span class="tech-tag">${tech.trim()}</span>`
            ).join('') : '';

        let revenueInfo = '';
        if (project.project_type === 'subscription') {
            const monthlyRevenue = (project.monthly_price || 0) * (project.subscriber_count || 0);
            revenueInfo = `
                <div class="revenue-card">
                    <div class="revenue-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
                    <div class="revenue-amount">${monthlyRevenue.toLocaleString()} Ø±.Ø³</div>
                </div>
                <div class="revenue-card">
                    <div class="revenue-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</div>
                    <div class="revenue-amount">${project.subscriber_count || 0}</div>
                </div>
            `;
        } else {
            const remaining = (project.total_amount || 0) - (project.paid_amount || 0);
            revenueInfo = `
                <div class="revenue-card">
                    <div class="revenue-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº</div>
                    <div class="revenue-amount">${(project.total_amount || 0).toLocaleString()} Ø±.Ø³</div>
                </div>
                <div class="revenue-card">
                    <div class="revenue-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                    <div class="revenue-amount">${remaining.toLocaleString()} Ø±.Ø³</div>
                </div>
            `;
        }

        const typeClass = project.project_type === 'subscription' ? 'type-subscription' : 'type-onetime';
        const typeName = project.project_type === 'subscription' ? 'Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ' : 'Ø¯ÙØ¹ ÙƒØ§Ù…Ù„';
        const statusBadge = getStatusBadgeHTML(project.status);

        return `
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="project-card">
                    <div class="project-header">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="project-type-badge ${typeClass}">${typeName}</div>
                            ${statusBadge}
                        </div>
                        <div class="project-title">${project.name}</div>
                        <div class="text-muted small mb-2">${project.project_code || 'N/A'}</div>
                        <div class="text-muted">${project.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­'}</div>
                    </div>
                    <div class="project-body">
                        <div class="revenue-info">
                            ${revenueInfo}
                        </div>
                        ${techTags ? `
                            <div class="tech-stack">
                                <div class="fw-bold mb-2">Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</div>
                                <div class="tech-tags">
                                    ${techTags}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="project-actions">
                        <button class="btn-action btn-primary" onclick="viewProjectDetails(${project.id})">
                            <i class="fas fa-eye me-1"></i> Ø¹Ø±Ø¶
                        </button>
                        ${project.project_type === 'subscription' ? `
                            <button class="btn-action btn-success" onclick="manageSubscribers(${project.id})">
                                <i class="fas fa-users me-1"></i> Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
                            </button>
                        ` : ''}
                        <button class="btn-action btn-warning" onclick="editProjectInForm(${project.id})">
                            <i class="fas fa-edit me-1"></i> ØªØ¹Ø¯ÙŠÙ„
                        </button>
                        <button class="btn-action btn-danger" onclick="deleteProjectFromDB(${project.id})">
                            <i class="fas fa-trash me-1"></i> Ø­Ø°Ù
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Get status badge HTML
    function getStatusBadgeHTML(status) {
        const statusMap = {
            'active': { class: 'bg-success', text: 'Ù†Ø´Ø·' },
            'completed': { class: 'bg-primary', text: 'Ù…ÙƒØªÙ…Ù„' },
            'on_hold': { class: 'bg-warning', text: 'Ù…Ø¹Ù„Ù‚' },
            'cancelled': { class: 'bg-danger', text: 'Ù…Ù„ØºÙ‰' }
        };

        const statusInfo = statusMap[status] || { class: 'bg-secondary', text: status };
        return `<span class="badge ${statusInfo.class}">${statusInfo.text}</span>`;
    }

    // Add project to database - WITH JWT
    async function addProject() {
        const projectData = {
            name: document.getElementById('projectName').value,
            project_type: document.getElementById('projectType').value,
            description: document.getElementById('description').value,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            technologies: document.getElementById('technologies').value,
            status: document.getElementById('status').value,
            priority: document.getElementById('priority').value,
            category: document.getElementById('category').value,
            estimated_hours: document.getElementById('estimatedHours').value,
            project_manager_id: document.getElementById('projectManagerId').value
        };

        // Add client for onetime projects
        if (projectData.project_type === 'onetime') {
            projectData.client_id = document.getElementById('clientId').value || null;
            projectData.total_amount = parseFloat(document.getElementById('totalAmount').value) || 0;
            projectData.paid_amount = parseFloat(document.getElementById('paidAmount').value) || 0;
        }

        // Add subscription data for subscription projects
        if (projectData.project_type === 'subscription') {
            projectData.monthly_price = parseFloat(document.getElementById('monthlyPrice').value) || 0;
            projectData.subscriber_count = projectSubscribers.length;
            projectData.subscription_clients = projectSubscribers.map(s => s.id);
        }

        // Validate required fields
        if (!projectData.name || !projectData.project_type) {
            alert('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            console.log('ğŸ’¾ Adding to database with JWT:', projectData);

            const response = await fetch('/api/v1/projects', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(projectData)
            });

            console.log('ğŸ’¾ Add response:', response.status);

            if (response.status === 401) {
                alert('âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                redirectToLogin();
                return;
            }

            if (response.ok) {
                const result = await response.json();
                alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');

                // Hide modal and reset
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
                modal.hide();
                resetModalToAddMode();

                // Reload from database
                await loadAllData();

                console.log('âœ… Project added to database:', result);
            } else {
                const error = await response.json();
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            }
        } catch (error) {
            console.error('âŒ Add error:', error);
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        } finally {
            hideLoading();
        }
    }

    // View project details
    function viewProjectDetails(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project) {
            alert('âŒ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }

        console.log('ğŸ‘ï¸ Viewing project:', project.name);

        // Create modal HTML
        const modalHTML = `
            <div class="modal fade" id="viewModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-eye me-2"></i>
                                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${project.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="fw-bold text-primary">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h6>
                                    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${project.name}</p>
                                    <p><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> ${project.project_code || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                    <p><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${project.project_type === 'subscription' ? 'Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ' : 'Ø¯ÙØ¹ ÙƒØ§Ù…Ù„'}</p>
                                    <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${getStatusText(project.status)}</p>
                                    <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${project.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="fw-bold text-primary">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h6>
                                    ${project.project_type === 'subscription' ? `
                                        <p><strong>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ:</strong> ${(project.monthly_price || 0).toLocaleString()} Ø±.Ø³</p>
                                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:</strong> ${project.subscriber_count || 0}</p>
                                        <p><strong>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ:</strong> ${((project.monthly_price || 0) * (project.subscriber_count || 0)).toLocaleString()} Ø±.Ø³</p>
                                    ` : `
                                        <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${(project.total_amount || 0).toLocaleString()} Ø±.Ø³</p>
                                        <p><strong>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</strong> ${(project.paid_amount || 0).toLocaleString()} Ø±.Ø³</p>
                                        <p><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${((project.total_amount || 0) - (project.paid_amount || 0)).toLocaleString()} Ø±.Ø³</p>
                                    `}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="fw-bold text-primary">Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ù†ÙŠØ©</h6>
                                    <p><strong>Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª:</strong> ${project.technologies || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</strong> ${project.start_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> ${project.end_date || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                            <button type="button" class="btn btn-warning" onclick="editProjectInForm(${project.id})" data-bs-dismiss="modal">
                                <i class="fas fa-edit me-2"></i>ØªØ¹Ø¯ÙŠÙ„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal
        const existingModal = document.getElementById('viewModal');
        if (existingModal) existingModal.remove();

        // Add and show modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('viewModal'));
        modal.show();

        // Cleanup on hide
        document.getElementById('viewModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // Edit project in form
    function editProjectInForm(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project) {
            alert('âŒ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }

        console.log('âœï¸ Editing project:', project.name);
        currentEditingProject = project;

        // Fill form with project data
        document.getElementById('projectName').value = project.name || '';
        document.getElementById('projectType').value = project.project_type || '';
        document.getElementById('description').value = project.description || '';
        document.getElementById('technologies').value = project.technologies || '';
        document.getElementById('status').value = project.status || 'active';
        document.getElementById('startDate').value = project.start_date || '';
        document.getElementById('endDate').value = project.end_date || '';

        // Show financial fields and fill them
        toggleProjectType();
        if (project.project_type === 'subscription') {
            document.getElementById('monthlyPrice').value = project.monthly_price || '';
            document.getElementById('subscriberCount').value = project.subscriber_count || '';
        } else if (project.project_type === 'onetime') {
            document.getElementById('totalAmount').value = project.total_amount || '';
            document.getElementById('paidAmount').value = project.paid_amount || '';
        }

        // Change modal to edit mode
        document.querySelector('#addProjectModal .modal-title').innerHTML = `
            <i class="fas fa-edit me-2"></i>
            ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${project.name}
        `;
        document.querySelector('#addProjectModal .modal-footer button[onclick="addProject()"]').innerHTML = `
            <i class="fas fa-save me-2"></i>
            Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        `;
        document.querySelector('#addProjectModal .modal-footer button[onclick="addProject()"]').setAttribute('onclick', 'updateProject()');

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('addProjectModal'));
        modal.show();
    }

    // Update project in database - WITH JWT
    async function updateProject() {
        if (!currentEditingProject) {
            alert('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­Ø¯Ø¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„');
            return;
        }

        const projectData = {
            name: document.getElementById('projectName').value,
            project_type: document.getElementById('projectType').value,
            description: document.getElementById('description').value,
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            technologies: document.getElementById('technologies').value,
            status: document.getElementById('status').value
        };

        // Add financial data
        if (projectData.project_type === 'subscription') {
            projectData.monthly_price = parseFloat(document.getElementById('monthlyPrice').value) || 0;
            projectData.subscriber_count = parseInt(document.getElementById('subscriberCount').value) || 0;
        } else if (projectData.project_type === 'onetime') {
            projectData.total_amount = parseFloat(document.getElementById('totalAmount').value) || 0;
            projectData.paid_amount = parseFloat(document.getElementById('paidAmount').value) || 0;
        }

        // Validate
        if (!projectData.name || !projectData.project_type) {
            alert('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        try {
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            console.log('ğŸ’¾ Updating in database with JWT:', currentEditingProject.id, projectData);

            const response = await fetch(`/api/v1/projects/${currentEditingProject.id}`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(projectData)
            });

            console.log('ğŸ’¾ Update response:', response.status);

            if (response.status === 401) {
                alert('âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                redirectToLogin();
                return;
            }

            if (response.ok) {
                const result = await response.json();
                alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');

                // Hide modal and reset
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProjectModal'));
                modal.hide();
                resetModalToAddMode();

                // Reload from database
                await loadAllData();

                console.log('âœ… Project updated in database:', result);
            } else {
                const error = await response.text();
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error);
            }
        } catch (error) {
            console.error('âŒ Update error:', error);
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        } finally {
            hideLoading();
        }
    }

    // Show subscribers modal
    function showSubscribersModal(project, subscriberClients = []) {
        const monthlyRevenue = (project.monthly_price || 0) * (project.subscriber_count || 0);

        const modalHTML = `
            <div class="modal fade" id="subscribersModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-users me-2"></i>
                                Ù…Ø´ØªØ±ÙƒÙŠÙ† Ù…Ø´Ø±ÙˆØ¹: ${project.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Project Summary -->
                            <div class="subscription-summary mb-4">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="summary-card text-center">
                                            <div class="summary-icon bg-primary">
                                                <i class="fas fa-users"></i>
                                            </div>
                                            <div class="summary-number">${project.subscriber_count || 0}</div>
                                            <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="summary-card text-center">
                                            <div class="summary-icon bg-success">
                                                <i class="fas fa-dollar-sign"></i>
                                            </div>
                                            <div class="summary-number">${(project.monthly_price || 0).toLocaleString()}</div>
                                            <div class="summary-label">Ø³Ø¹Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø±.Ø³)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="summary-card text-center">
                                            <div class="summary-icon bg-warning">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                            <div class="summary-number">${monthlyRevenue.toLocaleString()}</div>
                                            <div class="summary-label">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø±.Ø³)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Subscribers List -->
                            <div class="subscribers-container">
                                <h6 class="section-title mb-3">
                                    <i class="fas fa-list me-2"></i>
                                    Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
                                </h6>
                                <div id="subscribersListView">
                                    ${subscriberClients.length > 0 ?
                subscriberClients.map(client => createSubscriberCardHTML(client)).join('') :
                '<div class="text-center text-muted py-4"><i class="fas fa-users-slash fa-2x mb-2"></i><br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</div>'
            }
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                            <button type="button" class="btn btn-primary" onclick="addNewSubscriber(${project.id})">
                                <i class="fas fa-user-plus me-2"></i>
                                Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal
        const existingModal = document.getElementById('subscribersModal');
        if (existingModal) existingModal.remove();

        // Add and show modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('subscribersModal'));
        modal.show();

        // Cleanup on hide
        document.getElementById('subscribersModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // Create subscriber card HTML
    function createSubscriberCardHTML(client) {
        const clientType = client.client_type === 'company' ? 'Ø´Ø±ÙƒØ©' : 'ÙØ±Ø¯';
        const clientIcon = client.client_type === 'company' ? 'fas fa-building' : 'fas fa-user';

        return `
            <div class="subscriber-card">
                <div class="subscriber-avatar">
                    <i class="${clientIcon}"></i>
                </div>
                <div class="subscriber-details">
                    <div class="subscriber-name">${client.display_name || client.name}</div>
                    <div class="subscriber-type">
                        <span class="badge bg-light text-dark">${clientType}</span>
                    </div>
                    <div class="subscriber-contact">
                        <div class="contact-item">
                            <i class="fas fa-envelope me-1"></i>
                            <span>${client.email}</span>
                        </div>
                        ${client.phone ? `
                            <div class="contact-item">
                                <i class="fas fa-phone me-1"></i>
                                <span>${client.phone}</span>
                            </div>
                        ` : ''}
                        ${client.city ? `
                            <div class="contact-item">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <span>${client.city}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="subscriber-actions">
                    <button class="btn btn-sm btn-outline-primary" onclick="viewClientDetails(${client.id})" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeSubscriberFromProject(${client.id}, '${client.display_name || client.name}')" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ">
                        <i class="fas fa-user-times"></i>
                    </button>
                </div>
            </div>
        `;
    }

    // Modern alert system
    function showModernAlert(message, type = 'info', duration = 4000) {
        const alertTypes = {
            'success': { icon: 'fas fa-check-circle', color: 'success' },
            'error': { icon: 'fas fa-exclamation-triangle', color: 'danger' },
            'warning': { icon: 'fas fa-exclamation-circle', color: 'warning' },
            'info': { icon: 'fas fa-info-circle', color: 'info' }
        };

        const alertInfo = alertTypes[type] || alertTypes['info'];
        const alertId = 'alert-' + Date.now();

        const alertHTML = `
            <div class="toast align-items-center text-bg-${alertInfo.color} border-0 position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999;" id="${alertId}" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="${alertInfo.icon} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', alertHTML);

        const toastElement = document.getElementById(alertId);
        const toast = new bootstrap.Toast(toastElement, { delay: duration });
        toast.show();

        // Remove element after hiding
        toastElement.addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    }

    // Modern confirmation dialog
    function showModernConfirm(title, message, onConfirm, confirmText = 'ØªØ£ÙƒÙŠØ¯', cancelText = 'Ø¥Ù„ØºØ§Ø¡', type = 'warning') {
        const confirmId = 'confirm-' + Date.now();
        const typeColors = {
            'danger': 'text-bg-danger',
            'warning': 'text-bg-warning',
            'info': 'text-bg-info',
            'success': 'text-bg-success'
        };

        const confirmHTML = `
            <div class="modal fade" id="${confirmId}" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header ${typeColors[type]} text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                ${title}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="confirm-icon mb-3">
                                <i class="fas fa-question-circle fa-3x text-${type}"></i>
                            </div>
                            <p class="mb-0">${message}</p>
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">${cancelText}</button>
                            <button type="button" class="btn btn-${type}" onclick="confirmAction_${confirmId.replace('confirm-', '')}">${confirmText}</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add to page
        document.body.insertAdjacentHTML('beforeend', confirmHTML);

        // Create confirm action function
        window[`confirmAction_${confirmId.replace('confirm-', '')}`] = function () {
            const modal = bootstrap.Modal.getInstance(document.getElementById(confirmId));
            modal.hide();
            onConfirm();
        };

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById(confirmId));
        modal.show();

        // Cleanup
        document.getElementById(confirmId).addEventListener('hidden.bs.modal', function () {
            delete window[`confirmAction_${confirmId.replace('confirm-', '')}`];
            this.remove();
        });
    }

    // Delete project from database - WITH MODERN CONFIRMATION
    async function deleteProjectFromDB(projectId) {
        const project = projects.find(p => p.id === projectId);
        const projectName = project ? project.name : 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹';

        showModernConfirm(
            'ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
            `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ¹ "${projectName}" Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ<br><strong class="text-danger">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.</strong>`,
            async () => {
                await executeProjectDeletion(projectId, projectName);
            },
            'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
            'Ø¥Ù„ØºØ§Ø¡',
            'danger'
        );
    }

    // Execute project deletion
    async function executeProjectDeletion(projectId, projectName) {
        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            console.log('ğŸ—‘ï¸ Deleting from database with JWT:', projectId);

            const response = await fetch(`/api/v1/projects/${projectId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            console.log('ğŸ—‘ï¸ Delete response:', response.status);

            if (response.status === 401) {
                showModernAlert('âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
                redirectToLogin();
                return;
            }

            if (response.ok) {
                showModernAlert(`âœ… ØªÙ… Ø­Ø°Ù "${projectName}" Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­`, 'success');

                // Reload from database
                await loadAllData();

                console.log('âœ… Project deleted from database:', projectId);
            } else {
                const error = await response.text();
                showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ' + error, 'error');
            }
        } catch (error) {
            console.error('âŒ Delete error:', error);
            showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        } finally {
            hideLoading();
        }
    }

    // Helper functions
    function getStatusText(status) {
        const statusMap = {
            'active': 'Ù†Ø´Ø·',
            'completed': 'Ù…ÙƒØªÙ…Ù„',
            'on_hold': 'Ù…Ø¹Ù„Ù‚',
            'cancelled': 'Ù…Ù„ØºÙ‰'
        };
        return statusMap[status] || status;
    }

    async function manageSubscribers(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project || project.project_type !== 'subscription') {
            showModernAlert('âŒ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù„ÙŠØ³ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'error');
            return;
        }

        try {
            // Load project subscribers
            console.log(`ğŸ“‹ Loading subscribers for project: ${project.name}`);
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...');

            const response = await fetch(`/api/v1/projects/${projectId}/subscribers`, {
                method: 'GET',
                headers: getAuthHeaders()
            });

            let subscriberClients = [];
            if (response.ok) {
                const data = await response.json();
                subscriberClients = data.subscribers || [];
                console.log(`âœ… Loaded ${subscriberClients.length} subscribers`);
            } else {
                console.warn('âš ï¸ Could not load subscribers from API, using basic info');
            }

            hideLoading();
            showSubscribersModal(project, subscriberClients);

        } catch (error) {
            console.error('âŒ Error loading subscribers:', error);
            hideLoading();
            // Fallback to basic modal
            showSubscribersModal(project, []);
        }
    }

    function resetModalToAddMode() {
        currentEditingProject = null;
        projectSubscribers = [];
        document.getElementById('addProjectForm').reset();
        document.getElementById('subscribersList').innerHTML = '';
        hideAddClientForm();

        document.querySelector('#addProjectModal .modal-title').innerHTML = `
            <i class="fas fa-plus me-2"></i>
            Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯
        `;
        const saveButton = document.querySelector('#addProjectModal .modal-footer button[onclick="updateProject()"]');
        if (saveButton) {
            saveButton.innerHTML = `<i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹`;
            saveButton.setAttribute('onclick', 'addProject()');
        }
        setDefaultDates();
        toggleProjectType();
    }

    function toggleProjectType() {
        const projectType = document.getElementById('projectType').value;
        const subscriptionDiv = document.getElementById('subscriptionFinancial');
        const onetimeDiv = document.getElementById('onetimeFinancial');
        const subscriptionClientsDiv = document.getElementById('subscriptionClientsDiv');
        const onetimeClientDiv = document.getElementById('onetimeClientDiv');

        if (projectType === 'subscription') {
            subscriptionDiv.style.display = 'block';
            onetimeDiv.style.display = 'none';
            subscriptionClientsDiv.style.display = 'block';
            onetimeClientDiv.style.display = 'none';
            updateExpectedRevenue();
        } else if (projectType === 'onetime') {
            subscriptionDiv.style.display = 'none';
            onetimeDiv.style.display = 'block';
            subscriptionClientsDiv.style.display = 'none';
            onetimeClientDiv.style.display = 'block';
            updatePaymentDisplay();
        } else {
            subscriptionDiv.style.display = 'none';
            onetimeDiv.style.display = 'none';
            subscriptionClientsDiv.style.display = 'none';
            onetimeClientDiv.style.display = 'block';
        }
    }

    // Update expected revenue for subscription projects
    function updateExpectedRevenue() {
        const monthlyPrice = parseFloat(document.getElementById('monthlyPrice').value) || 0;
        const subscriberCount = projectSubscribers.length;
        const expectedRevenue = monthlyPrice * subscriberCount;

        document.getElementById('expectedRevenue').textContent = `${expectedRevenue.toLocaleString()} Ø±.Ø³ Ø´Ù‡Ø±ÙŠØ§Ù‹`;
        document.getElementById('subscriberCount').value = subscriberCount;
    }

    // Update payment display for onetime projects
    function updatePaymentDisplay() {
        const totalAmount = parseFloat(document.getElementById('totalAmount').value) || 0;
        const paidAmount = parseFloat(document.getElementById('paidAmount').value) || 0;
        const remaining = totalAmount - paidAmount;

        document.getElementById('paidDisplay').textContent = `${paidAmount.toLocaleString()} Ø±.Ø³`;
        document.getElementById('remainingDisplay').textContent = `${remaining.toLocaleString()} Ø±.Ø³`;
    }

    // Show add client form
    function showAddClientForm() {
        const form = document.getElementById('quickClientForm');
        form.classList.add('show');
    }

    // Hide add client form
    function hideAddClientForm() {
        const form = document.getElementById('quickClientForm');
        form.classList.remove('show');
        // Reset form
        document.getElementById('newClientName').value = '';
        document.getElementById('newClientEmail').value = '';
        document.getElementById('newClientPhone').value = '';
        document.getElementById('newClientCity').value = '';
    }

    // Save new client
    async function saveNewClient() {
        const clientData = {
            client_type: document.getElementById('newClientType').value,
            name: document.getElementById('newClientName').value.trim(),
            email: document.getElementById('newClientEmail').value.trim(),
            phone: document.getElementById('newClientPhone').value.trim(),
            city: document.getElementById('newClientCity').value.trim(),
            status: 'active'
        };

        if (clientData.client_type === 'company') {
            clientData.company_name = clientData.name;
        } else {
            const nameParts = clientData.name.split(' ');
            clientData.first_name = nameParts[0] || '';
            clientData.last_name = nameParts.slice(1).join(' ') || '';
        }

        if (!clientData.name || !clientData.email) {
            alert('âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        try {
            console.log('ğŸ’¾ Adding new client:', clientData);

            const response = await fetch('/api/v1/clients', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(clientData)
            });

            if (response.status === 401) {
                alert('âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                redirectToLogin();
                return;
            }

            if (response.ok) {
                const result = await response.json();
                alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ "${clientData.name}" Ø¨Ù†Ø¬Ø§Ø­!`);

                // Add to local clients array
                clients.push(result.client || result);
                populateClientSelect();

                // Select the new client
                document.getElementById('clientId').value = (result.client || result).id;

                hideAddClientForm();
                console.log('âœ… Client added:', result);
            } else {
                const error = await response.json();
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            }
        } catch (error) {
            console.error('âŒ Add client error:', error);
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }

    // Add subscriber for subscription projects
    function addSubscriber() {
        const subscriberHTML = `
            <div class="subscriber-item" data-temp-id="${Date.now()}">
                <div class="subscriber-info">
                    <select class="form-select mb-2" onchange="updateSubscriberInfo(this)">
                        <option value="">Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</option>
                        ${clients.map(client => `<option value="${client.id}">${client.display_name || client.name} - ${client.email}</option>`).join('')}
                    </select>
                    <div class="subscriber-details" style="display: none;">
                        <div class="subscriber-name"></div>
                        <div class="subscriber-email"></div>
                    </div>
                </div>
                <div class="subscriber-actions">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSubscriber(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;

        document.getElementById('subscribersList').insertAdjacentHTML('beforeend', subscriberHTML);
    }

    // Update subscriber info when client is selected
    function updateSubscriberInfo(selectElement) {
        const subscriberItem = selectElement.closest('.subscriber-item');
        const clientId = selectElement.value;
        const detailsDiv = subscriberItem.querySelector('.subscriber-details');
        const nameDiv = subscriberItem.querySelector('.subscriber-name');
        const emailDiv = subscriberItem.querySelector('.subscriber-email');

        if (clientId) {
            const client = clients.find(c => c.id == clientId);
            if (client) {
                nameDiv.textContent = client.display_name || client.name;
                emailDiv.textContent = client.email;
                detailsDiv.style.display = 'block';
                selectElement.style.display = 'none';

                // Add to subscribers array
                if (!projectSubscribers.find(s => s.id == clientId)) {
                    projectSubscribers.push(client);
                    updateExpectedRevenue();
                }
            }
        }
    }

    // Remove subscriber
    function removeSubscriber(button) {
        const subscriberItem = button.closest('.subscriber-item');
        const select = subscriberItem.querySelector('select');
        const clientId = select.value;

        // Remove from subscribers array
        if (clientId) {
            projectSubscribers = projectSubscribers.filter(s => s.id != clientId);
            updateExpectedRevenue();
        }

        subscriberItem.remove();
    }

    // Event listeners for real-time updates
    function addEventListeners() {
        document.getElementById('searchInput').addEventListener('input', filterProjects);
        document.getElementById('typeFilter').addEventListener('change', filterProjects);
        document.getElementById('statusFilter').addEventListener('change', filterProjects);
        document.getElementById('techFilter').addEventListener('change', filterProjects);

        // Financial calculations
        document.getElementById('monthlyPrice').addEventListener('input', updateExpectedRevenue);
        document.getElementById('totalAmount').addEventListener('input', updatePaymentDisplay);
        document.getElementById('paidAmount').addEventListener('input', updatePaymentDisplay);

        document.getElementById('addProjectModal').addEventListener('hidden.bs.modal', function () {
            resetModalToAddMode();
        });
    }

    // Make functions globally available
    window.toggleProjectType = toggleProjectType;
    window.updateExpectedRevenue = updateExpectedRevenue;
    window.updatePaymentDisplay = updatePaymentDisplay;
    window.showAddClientForm = showAddClientForm;
    window.hideAddClientForm = hideAddClientForm;
    window.saveNewClient = saveNewClient;
    window.addSubscriber = addSubscriber;
    window.updateSubscriberInfo = updateSubscriberInfo;
    window.removeSubscriber = removeSubscriber;
    window.toggleClientTypeFields = function () {
        // Can be used for future enhancements
    };

    // Add new subscriber to project
    window.addNewSubscriber = async function (projectId) {
        // Close current modal
        const subscribersModal = bootstrap.Modal.getInstance(document.getElementById('subscribersModal'));
        if (subscribersModal) subscribersModal.hide();

        // Show client selection modal for adding subscriber
        setTimeout(() => {
            showClientSelectionModal(projectId);
        }, 300);
    };

    // Show client selection modal for adding subscribers
    window.showClientSelectionModal = function (projectId) {
        const modalHTML = `
              <div class="modal fade" id="clientSelectionModal" tabindex="-1">
                  <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                          <div class="modal-header bg-primary text-white">
                              <h5 class="modal-title">
                                  <i class="fas fa-user-plus me-2"></i>
                                  Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
                              </h5>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <div class="mb-3">
                                  <input type="text" class="form-control" id="clientSearchInput" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„..." 
                                         onkeyup="filterClientsForSelection()">
                              </div>
                              <div id="clientsForSelectionList" class="clients-list-container" style="max-height: 400px; overflow-y: auto;">
                                  <div class="text-center text-muted py-4">
                                      <div class="spinner-border" role="status"></div>
                                      <div class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</div>
                                  </div>
                              </div>
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                          </div>
                      </div>
                  </div>
              </div>
          `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('clientSelectionModal'));
        modal.show();

        // Load clients for selection
        loadClientsForSelection(projectId);

        // Cleanup
        document.getElementById('clientSelectionModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    };

    // Remove subscriber from project
    window.removeSubscriberFromProject = function (clientId, clientName) {
        showModernConfirm(
            'ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
            `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ "${clientName}"ØŸ<br>ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØªÙ‡Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹.`,
            async () => {
                await executeRemoveSubscriber(clientId, clientName);
            },
            'Ù†Ø¹Ù…ØŒ Ø£Ù„ØºÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
            'Ø¥Ù„ØºØ§Ø¡',
            'warning'
        );
    };

    // View client details
    window.viewClientDetails = function (clientId) {
        const client = clients.find(c => c.id === clientId);
        if (!client) {
            showModernAlert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
            return;
        }

        const clientType = client.client_type === 'company' ? 'Ø´Ø±ÙƒØ©' : 'ÙØ±Ø¯';
        const clientIcon = client.client_type === 'company' ? 'fas fa-building' : 'fas fa-user';

        const modalHTML = `
              <div class="modal fade" id="clientDetailsModal" tabindex="-1">
                  <div class="modal-dialog modal-lg">
                      <div class="modal-content">
                          <div class="modal-header bg-info text-white">
                              <h5 class="modal-title">
                                  <i class="${clientIcon} me-2"></i>
                                  ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client.display_name || client.name}
                              </h5>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                          </div>
                          <div class="modal-body">
                              <div class="row">
                                  <div class="col-md-6">
                                      <div class="detail-section">
                                          <h6 class="section-title">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h6>
                                          <div class="detail-item">
                                              <label>Ø§Ù„Ø§Ø³Ù…:</label>
                                              <span>${client.display_name || client.name}</span>
                                          </div>
                                          <div class="detail-item">
                                              <label>Ø§Ù„Ù†ÙˆØ¹:</label>
                                              <span class="badge bg-light text-dark">${clientType}</span>
                                          </div>
                                          <div class="detail-item">
                                              <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                                              <span>${client.email}</span>
                                          </div>
                                          ${client.phone ? `
                                              <div class="detail-item">
                                                  <label>Ø§Ù„Ù‡Ø§ØªÙ:</label>
                                                  <span>${client.phone}</span>
                                              </div>
                                          ` : ''}
                                      </div>
                                  </div>
                                  <div class="col-md-6">
                                      <div class="detail-section">
                                          <h6 class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h6>
                                          ${client.city ? `
                                              <div class="detail-item">
                                                  <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                                                  <span>${client.city}</span>
                                              </div>
                                          ` : ''}
                                          ${client.address ? `
                                              <div class="detail-item">
                                                  <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                                                  <span>${client.address}</span>
                                              </div>
                                          ` : ''}
                                          <div class="detail-item">
                                              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</label>
                                              <span>${new Date(client.created_at).toLocaleDateString('ar-SA')}</span>
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          </div>
                          <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                          </div>
                      </div>
                  </div>
              </div>
          `;

        // Remove existing modal
        const existingModal = document.getElementById('clientDetailsModal');
        if (existingModal) existingModal.remove();

        // Add and show modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('clientDetailsModal'));
        modal.show();

        // Cleanup
        document.getElementById('clientDetailsModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    };
    window.filterProjects = filterProjects;
    window.addProject = addProject;
    window.updateProject = updateProject;
    window.viewProjectDetails = viewProjectDetails;
    window.editProjectInForm = editProjectInForm;
    window.deleteProjectFromDB = deleteProjectFromDB;
    window.manageSubscribers = manageSubscribers;
    window.loadClientsForSelection = loadClientsForSelection;
    window.displayClientsForSelection = displayClientsForSelection;
    window.filterClientsForSelection = filterClientsForSelection;
    window.addClientToSubscription = addClientToSubscription;
    window.executeRemoveSubscriber = executeRemoveSubscriber;
    window.getCurrentProjectIdFromModal = getCurrentProjectIdFromModal;

    // Load clients for selection
    async function loadClientsForSelection(projectId) {
        try {
            const response = await fetch('/api/v1/clients/', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const data = await response.json();
                displayClientsForSelection(data.clients || [], projectId);
            } else {
                document.getElementById('clientsForSelectionList').innerHTML =
                    '<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>';
            }
        } catch (error) {
            console.error('Error loading clients:', error);
            document.getElementById('clientsForSelectionList').innerHTML =
                '<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
        }
    }

    // Display clients for selection
    function displayClientsForSelection(clients, projectId) {
        const container = document.getElementById('clientsForSelectionList');

        if (clients.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-users-slash fa-2x mb-2"></i><br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…ØªØ§Ø­ÙŠÙ†</div>';
            return;
        }

        const clientsHTML = clients.map(client => {
            const clientType = client.client_type === 'company' ? 'Ø´Ø±ÙƒØ©' : 'ÙØ±Ø¯';
            const clientIcon = client.client_type === 'company' ? 'fas fa-building' : 'fas fa-user';
            const safeName = (client.display_name || client.name).replace(/'/g, "\\'");

            return `
                <div class="client-selection-item" data-client-name="${client.display_name || client.name}" data-client-email="${client.email}">
                    <div class="d-flex align-items-center">
                        <div class="client-avatar me-3">
                            <i class="${clientIcon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="client-name">${client.display_name || client.name}</div>
                            <div class="client-details text-muted">
                                <span class="badge bg-light text-dark me-2">${clientType}</span>
                                ${client.email}
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="addClientToSubscription(${projectId}, ${client.id}, '${safeName}')">
                            <i class="fas fa-plus me-1"></i>
                            Ø¥Ø¶Ø§ÙØ©
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = clientsHTML;
    }

    // Filter clients for selection
    function filterClientsForSelection() {
        const searchTerm = document.getElementById('clientSearchInput').value.toLowerCase();
        const clientItems = document.querySelectorAll('.client-selection-item');

        clientItems.forEach(item => {
            const name = item.dataset.clientName.toLowerCase();
            const email = item.dataset.clientEmail.toLowerCase();

            if (name.includes(searchTerm) || email.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Add client to subscription
    async function addClientToSubscription(projectId, clientId, clientName) {
        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ...');

            const response = await fetch(`/api/v1/projects/${projectId}/subscribers`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ client_id: clientId })
            });

            if (response.ok) {
                showModernAlert(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${clientName}" ÙƒÙ…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­`, 'success');

                // Close selection modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('clientSelectionModal'));
                if (modal) modal.hide();

                // Reload projects and show updated subscribers
                await loadAllData();
                setTimeout(() => manageSubscribers(projectId), 500);
            } else {
                const error = await response.json();
                showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
            }
        } catch (error) {
            console.error('Error adding subscriber:', error);
            showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        } finally {
            hideLoading();
        }
    }

    // Execute remove subscriber
    async function executeRemoveSubscriber(clientId, clientName) {
        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ...');

            // Find current project (assuming we're in subscribers modal)
            const currentProjectId = getCurrentProjectIdFromModal();
            if (!currentProjectId) {
                showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'error');
                return;
            }

            const response = await fetch(`/api/v1/projects/${currentProjectId}/subscribers/${clientId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                showModernAlert(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ "${clientName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');

                // Reload projects and refresh modal
                await loadAllData();
                setTimeout(() => manageSubscribers(currentProjectId), 500);
            } else {
                const error = await response.json();
                showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
            }
        } catch (error) {
            console.error('Error removing subscriber:', error);
            showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        } finally {
            hideLoading();
        }
    }

    // Get current project ID from modal (helper function)
    function getCurrentProjectIdFromModal() {
        const modal = document.getElementById('subscribersModal');
        if (!modal) return null;

        const addButton = modal.querySelector('button[onclick*="addNewSubscriber"]');
        if (!addButton) return null;

        const onclickAttr = addButton.getAttribute('onclick');
        const match = onclickAttr.match(/addNewSubscriber\((\d+)\)/);
        return match ? parseInt(match[1]) : null;
    }

    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;

        const futureDate = new Date();
        futureDate.setMonth(futureDate.getMonth() + 3);
        document.getElementById('endDate').value = futureDate.toISOString().split('T')[0];
    }

    function filterProjects() {
        const typeFilter = document.getElementById('typeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        const techFilter = document.getElementById('techFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();

        let filteredProjects = [...projects];

        if (typeFilter) {
            filteredProjects = filteredProjects.filter(project => project.project_type === typeFilter);
        }

        if (statusFilter) {
            filteredProjects = filteredProjects.filter(project => project.status === statusFilter);
        }

        if (techFilter) {
            filteredProjects = filteredProjects.filter(project =>
                project.technologies && project.technologies.toLowerCase().includes(techFilter.toLowerCase())
            );
        }

        if (searchInput) {
            filteredProjects = filteredProjects.filter(project =>
                project.name.toLowerCase().includes(searchInput) ||
                (project.description && project.description.toLowerCase().includes(searchInput)) ||
                (project.project_code && project.project_code.toLowerCase().includes(searchInput))
            );
        }

        displayProjectsFromDB(filteredProjects);
        console.log(`ğŸ” ØªÙ… ÙÙ„ØªØ±Ø© ${filteredProjects.length} Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ø£ØµÙ„ ${projects.length}`);
    }

    // UI feedback functions
    function showLoading(message) {
        console.log('â³ ' + message);
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'block';
            const h5 = loadingState.querySelector('h5');
            if (h5) h5.textContent = message;
        }
    }

    function hideLoading() {
        console.log('âœ“ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„');
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
    }

    // Add new subscriber to project
    async function addNewSubscriber(projectId) {
        // Close current modal
        const subscribersModal = bootstrap.Modal.getInstance(document.getElementById('subscribersModal'));
        if (subscribersModal) subscribersModal.hide();

        // Show client selection modal for adding subscriber
        setTimeout(() => {
            showClientSelectionModal(projectId);
        }, 300);
    }

    // Show client selection modal for adding subscribers
    function showClientSelectionModal(projectId) {
        const modalHTML = `
            <div class="modal fade" id="clientSelectionModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-user-plus me-2"></i>
                                Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="clientSearchInput" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„..." 
                                       onkeyup="filterClientsForSelection()">
                            </div>
                            <div id="clientsForSelectionList" class="clients-list-container" style="max-height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted py-4">
                                    <div class="spinner-border" role="status"></div>
                                    <div class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡...</div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('clientSelectionModal'));
        modal.show();

        // Load clients for selection
        loadClientsForSelection(projectId);

        // Cleanup
        document.getElementById('clientSelectionModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // Load clients for selection
    async function loadClientsForSelection(projectId) {
        try {
            const response = await fetch('/api/v1/clients/', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                const data = await response.json();
                displayClientsForSelection(data.clients || [], projectId);
            } else {
                document.getElementById('clientsForSelectionList').innerHTML =
                    '<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>';
            }
        } catch (error) {
            console.error('Error loading clients:', error);
            document.getElementById('clientsForSelectionList').innerHTML =
                '<div class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</div>';
        }
    }

    // Display clients for selection
    function displayClientsForSelection(clients, projectId) {
        const container = document.getElementById('clientsForSelectionList');

        if (clients.length === 0) {
            container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-users-slash fa-2x mb-2"></i><br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…ØªØ§Ø­ÙŠÙ†</div>';
            return;
        }

        const clientsHTML = clients.map(client => {
            const clientType = client.client_type === 'company' ? 'Ø´Ø±ÙƒØ©' : 'ÙØ±Ø¯';
            const clientIcon = client.client_type === 'company' ? 'fas fa-building' : 'fas fa-user';

            return `
                <div class="client-selection-item" data-client-name="${client.display_name || client.name}" data-client-email="${client.email}">
                    <div class="d-flex align-items-center">
                        <div class="client-avatar me-3">
                            <i class="${clientIcon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="client-name">${client.display_name || client.name}</div>
                            <div class="client-details text-muted">
                                <span class="badge bg-light text-dark me-2">${clientType}</span>
                                ${client.email}
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="addClientToSubscription(${projectId}, ${client.id}, '${client.display_name || client.name}')">
                            <i class="fas fa-plus me-1"></i>
                            Ø¥Ø¶Ø§ÙØ©
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        container.innerHTML = clientsHTML;
    }

    // Filter clients for selection
    function filterClientsForSelection() {
        const searchTerm = document.getElementById('clientSearchInput').value.toLowerCase();
        const clientItems = document.querySelectorAll('.client-selection-item');

        clientItems.forEach(item => {
            const name = item.dataset.clientName.toLowerCase();
            const email = item.dataset.clientEmail.toLowerCase();

            if (name.includes(searchTerm) || email.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Add client to subscription
    async function addClientToSubscription(projectId, clientId, clientName) {
        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ...');

            const response = await fetch(`/api/v1/projects/${projectId}/subscribers`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ client_id: clientId })
            });

            if (response.ok) {
                showModernAlert(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${clientName}" ÙƒÙ…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­`, 'success');

                // Close selection modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('clientSelectionModal'));
                if (modal) modal.hide();

                // Reload projects and show updated subscribers
                await loadAllData();
                setTimeout(() => manageSubscribers(projectId), 500);
            } else {
                const error = await response.json();
                showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
            }
        } catch (error) {
            console.error('Error adding subscriber:', error);
            showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        } finally {
            hideLoading();
        }
    }

    // Remove subscriber from project
    function removeSubscriberFromProject(clientId, clientName) {
        showModernConfirm(
            'ØªØ£ÙƒÙŠØ¯ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
            `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ "${clientName}"ØŸ<br>ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØªÙ‡Ù… Ù„Ø§Ø­Ù‚Ø§Ù‹.`,
            async () => {
                await executeRemoveSubscriber(clientId, clientName);
            },
            'Ù†Ø¹Ù…ØŒ Ø£Ù„ØºÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
            'Ø¥Ù„ØºØ§Ø¡',
            'warning'
        );
    }

    // Execute remove subscriber
    async function executeRemoveSubscriber(clientId, clientName) {
        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ...');

            // Find current project (assuming we're in subscribers modal)
            const currentProjectId = getCurrentProjectIdFromModal();
            if (!currentProjectId) {
                showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'error');
                return;
            }

            const response = await fetch(`/api/v1/projects/${currentProjectId}/subscribers/${clientId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });

            if (response.ok) {
                showModernAlert(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ "${clientName}" Ø¨Ù†Ø¬Ø§Ø­`, 'success');

                // Reload projects and refresh modal
                await loadAllData();
                setTimeout(() => manageSubscribers(currentProjectId), 500);
            } else {
                const error = await response.json();
                showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ' + (error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
            }
        } catch (error) {
            console.error('Error removing subscriber:', error);
            showModernAlert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        } finally {
            hideLoading();
        }
    }

    // Get current project ID from modal (helper function)
    function getCurrentProjectIdFromModal() {
        const modal = document.getElementById('subscribersModal');
        if (!modal) return null;

        const addButton = modal.querySelector('button[onclick*="addNewSubscriber"]');
        if (!addButton) return null;

        const onclickAttr = addButton.getAttribute('onclick');
        const match = onclickAttr.match(/addNewSubscriber\((\d+)\)/);
        return match ? parseInt(match[1]) : null;
    }

    // View client details
    function viewClientDetails(clientId) {
        const client = clients.find(c => c.id === clientId);
        if (!client) {
            showModernAlert('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
            return;
        }

        const clientType = client.client_type === 'company' ? 'Ø´Ø±ÙƒØ©' : 'ÙØ±Ø¯';
        const clientIcon = client.client_type === 'company' ? 'fas fa-building' : 'fas fa-user';

        const modalHTML = `
            <div class="modal fade" id="clientDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-info text-white">
                            <h5 class="modal-title">
                                <i class="${clientIcon} me-2"></i>
                                ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client.display_name || client.name}
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="detail-section">
                                        <h6 class="section-title">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h6>
                                        <div class="detail-item">
                                            <label>Ø§Ù„Ø§Ø³Ù…:</label>
                                            <span>${client.display_name || client.name}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Ø§Ù„Ù†ÙˆØ¹:</label>
                                            <span class="badge bg-light text-dark">${clientType}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                                            <span>${client.email}</span>
                                        </div>
                                        ${client.phone ? `
                                            <div class="detail-item">
                                                <label>Ø§Ù„Ù‡Ø§ØªÙ:</label>
                                                <span>${client.phone}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="detail-section">
                                        <h6 class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h6>
                                        ${client.city ? `
                                            <div class="detail-item">
                                                <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©:</label>
                                                <span>${client.city}</span>
                                            </div>
                                        ` : ''}
                                        ${client.address ? `
                                            <div class="detail-item">
                                                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                                                <span>${client.address}</span>
                                            </div>
                                        ` : ''}
                                        <div class="detail-item">
                                            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</label>
                                            <span>${new Date(client.created_at).toLocaleDateString('ar-SA')}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal
        const existingModal = document.getElementById('clientDetailsModal');
        if (existingModal) existingModal.remove();

        // Add and show modal
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modal = new bootstrap.Modal(document.getElementById('clientDetailsModal'));
        modal.show();

        // Cleanup
        document.getElementById('clientDetailsModal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }
</script>
{% endblock %}