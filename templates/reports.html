{% extends "base_layout.html" %}

{% block title %}التقارير والإحصائيات - نظام ERP{% endblock %}
{% block page_title %}التقارير والإحصائيات{% endblock %}

{% block extra_css %}
<style>
    .report-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(226, 232, 240, 0.8);
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .report-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 4px;
        background: var(--primary-gradient);
    }

    .report-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }

    .report-card.success::before {
        background: var(--success-gradient);
    }

    .report-card.warning::before {
        background: var(--warning-gradient);
    }

    .report-card.secondary::before {
        background: var(--secondary-gradient);
    }

    .chart-container {
        background: white;
        border-radius: var(--border-radius);
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(226, 232, 240, 0.8);
        position: relative;
        min-height: 400px;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(226, 232, 240, 0.5);
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
    }

    .chart-subtitle {
        color: #64748b;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
    }

    .chart-period {
        background: rgba(102, 126, 234, 0.1);
        border: 1px solid rgba(102, 126, 234, 0.2);
        color: #667eea;
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-smooth);
    }

    .chart-period.active {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-item {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(226, 232, 240, 0.8);
        position: relative;
        overflow: hidden;
        transition: var(--transition-smooth);
    }

    .stat-item::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100%;
        height: 4px;
    }

    .stat-item.primary::before {
        background: var(--primary-gradient);
    }

    .stat-item.success::before {
        background: var(--success-gradient);
    }

    .stat-item.warning::before {
        background: var(--warning-gradient);
    }

    .stat-item.secondary::before {
        background: var(--secondary-gradient);
    }

    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--border-radius);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: white;
    }

    .stat-icon.primary {
        background: var(--primary-gradient);
    }

    .stat-icon.success {
        background: var(--success-gradient);
    }

    .stat-icon.warning {
        background: var(--warning-gradient);
    }

    .stat-icon.secondary {
        background: var(--secondary-gradient);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .stat-change {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-top: 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .stat-change.positive {
        color: #10b981;
    }

    .stat-change.negative {
        color: #ef4444;
    }

    .filters-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .export-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-export {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        border: 1px solid rgba(226, 232, 240, 0.8);
        background: white;
        color: #64748b;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
    }

    .btn-export::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
        transition: var(--transition-smooth);
    }

    .btn-export:hover {
        border-color: #667eea;
        color: #667eea;
        transform: translateY(-1px);
    }

    .btn-export:hover::before {
        left: 100%;
    }

    .data-table {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(226, 232, 240, 0.8);
        overflow-x: auto;
    }

    .table-modern {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
    }

    .table-modern th,
    .table-modern td {
        padding: 0.75rem;
        text-align: right;
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
    }

    .table-modern th {
        background: rgba(248, 250, 252, 0.8);
        font-weight: 600;
        color: #374151;
        font-size: 0.875rem;
    }

    .table-modern tbody tr:hover {
        background: rgba(248, 250, 252, 0.5);
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 4rem;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(102, 126, 234, 0.1);
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .chart-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .chart-controls {
            justify-content: center;
        }

        .export-buttons {
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="content-header">
    <div>
        <h1 class="page-title">التقارير والإحصائيات</h1>
        <p class="page-subtitle">تحليل شامل لأداء الأعمال والمشاريع</p>
    </div>
</div>

<!-- Filters Section -->
<div class="filters-section">
    <div class="row align-items-center">
        <div class="col-lg-2 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted">من تاريخ</label>
            <input type="date" class="form-control" id="startDate">
        </div>
        <div class="col-lg-2 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted">إلى تاريخ</label>
            <input type="date" class="form-control" id="endDate">
        </div>
        <div class="col-lg-3 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted">المشروع</label>
            <select class="form-select" id="projectFilter">
                <option value="">جميع المشاريع</option>
            </select>
        </div>
        <div class="col-lg-2 col-md-6 mb-3 mb-lg-0">
            <label class="form-label small text-muted d-block">&nbsp;</label>
            <button class="btn btn-modern btn-primary-modern w-100" onclick="generateReports()">
                <i class="fas fa-chart-bar me-2"></i>
                إنشاء التقارير
            </button>
        </div>
        <div class="col-lg-3 col-md-12">
            <label class="form-label small text-muted">تصدير التقارير</label>
            <div class="export-buttons">
                <button class="btn-export" onclick="exportReport('pdf')">
                    <i class="fas fa-file-pdf me-1"></i>
                    PDF
                </button>
                <button class="btn-export" onclick="exportReport('excel')">
                    <i class="fas fa-file-excel me-1"></i>
                    Excel
                </button>
                <button class="btn-export" onclick="exportReport('csv')">
                    <i class="fas fa-file-csv me-1"></i>
                    CSV
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="loading" class="loading-spinner" style="display: none;">
    <div class="spinner"></div>
</div>

<!-- Statistics Grid -->
<div class="stats-grid" id="statsGrid">
    <div class="stat-item primary">
        <div class="stat-header">
            <div>
                <div class="stat-number" id="totalProjects">0</div>
                <div class="stat-label">إجمالي المشاريع</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+12% هذا الشهر</span>
                </div>
            </div>
            <div class="stat-icon primary">
                <i class="fas fa-project-diagram"></i>
            </div>
        </div>
    </div>

    <div class="stat-item success">
        <div class="stat-header">
            <div>
                <div class="stat-number" id="completedTasks">0</div>
                <div class="stat-label">المهام المكتملة</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+8% من الأسبوع الماضي</span>
                </div>
            </div>
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
    </div>

    <div class="stat-item warning">
        <div class="stat-header">
            <div>
                <div class="stat-number" id="totalRevenue">0</div>
                <div class="stat-label">إجمالي الإيرادات</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+15% هذا الشهر</span>
                </div>
            </div>
            <div class="stat-icon warning">
                <i class="fas fa-dollar-sign"></i>
            </div>
        </div>
    </div>

    <div class="stat-item secondary">
        <div class="stat-header">
            <div>
                <div class="stat-number" id="activeEmployees">0</div>
                <div class="stat-label">الموظفين النشطين</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i>
                    <span>+3 موظفين جدد</span>
                </div>
            </div>
            <div class="stat-icon secondary">
                <i class="fas fa-users"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <div class="chart-title">تقدم المشاريع</div>
                    <div class="chart-subtitle">نظرة عامة على حالة المشاريع الحالية</div>
                </div>
                <div class="chart-controls">
                    <span class="chart-period active" onclick="updateChartPeriod('week', this)">الأسبوع</span>
                    <span class="chart-period" onclick="updateChartPeriod('month', this)">الشهر</span>
                    <span class="chart-period" onclick="updateChartPeriod('year', this)">السنة</span>
                </div>
            </div>
            <canvas id="projectsChart" width="400" height="200"></canvas>
        </div>
    </div>

    <div class="col-lg-4 mb-4">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <div class="chart-title">توزيع المهام</div>
                    <div class="chart-subtitle">حسب الحالة</div>
                </div>
            </div>
            <canvas id="tasksChart" width="300" height="300"></canvas>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <div class="chart-title">الإيرادات الشهرية</div>
                    <div class="chart-subtitle">الأشهر الـ 12 الماضية</div>
                </div>
            </div>
            <canvas id="revenueChart" width="400" height="200"></canvas>
        </div>
    </div>

    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <div class="chart-header">
                <div>
                    <div class="chart-title">أداء الفرق</div>
                    <div class="chart-subtitle">حسب عدد المهام المكتملة</div>
                </div>
            </div>
            <canvas id="teamPerformanceChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<!-- Data Tables -->
<div class="data-table">
    <div class="chart-header">
        <div>
            <div class="chart-title">تفاصيل المشاريع</div>
            <div class="chart-subtitle">قائمة المشاريع مع الإحصائيات</div>
        </div>
    </div>
    <table class="table-modern">
        <thead>
            <tr>
                <th>اسم المشروع</th>
                <th>العميل</th>
                <th>الحالة</th>
                <th>التقدم</th>
                <th>الميزانية</th>
                <th>تاريخ الانتهاء</th>
            </tr>
        </thead>
        <tbody id="projectsTableBody">
            <!-- Data will be loaded here -->
        </tbody>
    </table>
</div>

<div class="data-table">
    <div class="chart-header">
        <div>
            <div class="chart-title">أداء الموظفين</div>
            <div class="chart-subtitle">إحصائيات المهام والساعات</div>
        </div>
    </div>
    <table class="table-modern">
        <thead>
            <tr>
                <th>الموظف</th>
                <th>القسم</th>
                <th>المهام المكتملة</th>
                <th>المهام الجارية</th>
                <th>الساعات المعمولة</th>
                <th>معدل الإنجاز</th>
            </tr>
        </thead>
        <tbody id="employeesTableBody">
            <!-- Data will be loaded here -->
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let projects = [];
    let tasks = [];
    let employees = [];
    let clients = [];
    let charts = {};

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        loadAllData();
        setDefaultDates();
    });

    // Set default dates (last 30 days)
    function setDefaultDates() {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
    }

    // Load all data
    async function loadAllData() {
        try {
            document.getElementById('loading').style.display = 'flex';

            await Promise.all([
                loadProjects(),
                loadTasks(),
                loadEmployees(),
                loadClients()
            ]);

            generateReports();
        } catch (error) {
            console.error('Error loading data:', error);
            showAlert('حدث خطأ في تحميل البيانات', 'danger');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Load projects
    async function loadProjects() {
        const response = await fetch('/api/v1/projects', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            projects = await response.json();
            populateProjectFilter();
        }
    }

    // Load tasks
    async function loadTasks() {
        const response = await fetch('/api/v1/tasks', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            tasks = await response.json();
        }
    }

    // Load employees
    async function loadEmployees() {
        const response = await fetch('/api/v1/employees', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            employees = await response.json();
        }
    }

    // Load clients
    async function loadClients() {
        const response = await fetch('/api/v1/clients', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            clients = await response.json();
        }
    }

    // Populate project filter
    function populateProjectFilter() {
        const filter = document.getElementById('projectFilter');
        filter.innerHTML = '<option value="">جميع المشاريع</option>';

        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            filter.appendChild(option);
        });
    }

    // Generate reports
    function generateReports() {
        updateStatistics();
        createCharts();
        populateTables();
    }

    // Update statistics
    function updateStatistics() {
        const filteredProjects = filterProjectsByDate();
        const filteredTasks = filterTasksByDate();

        document.getElementById('totalProjects').textContent = filteredProjects.length;
        document.getElementById('completedTasks').textContent = filteredTasks.filter(t => t.status === 'completed').length;

        // Calculate total revenue from projects
        const totalRevenue = filteredProjects.reduce((sum, project) => sum + (project.budget || 0), 0);
        document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

        document.getElementById('activeEmployees').textContent = employees.length;
    }

    // Filter projects by date
    function filterProjectsByDate() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const projectFilter = document.getElementById('projectFilter').value;

        let filtered = projects;

        if (startDate && endDate) {
            filtered = filtered.filter(project => {
                const projectDate = new Date(project.start_date);
                return projectDate >= new Date(startDate) && projectDate <= new Date(endDate);
            });
        }

        if (projectFilter) {
            filtered = filtered.filter(project => project.id == projectFilter);
        }

        return filtered;
    }

    // Filter tasks by date
    function filterTasksByDate() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const projectFilter = document.getElementById('projectFilter').value;

        let filtered = tasks;

        if (startDate && endDate) {
            filtered = filtered.filter(task => {
                const taskDate = new Date(task.start_date);
                return taskDate >= new Date(startDate) && taskDate <= new Date(endDate);
            });
        }

        if (projectFilter) {
            filtered = filtered.filter(task => task.project_id == projectFilter);
        }

        return filtered;
    }

    // Create charts
    function createCharts() {
        createProjectsChart();
        createTasksChart();
        createRevenueChart();
        createTeamPerformanceChart();
    }

    // Create projects chart
    function createProjectsChart() {
        const ctx = document.getElementById('projectsChart').getContext('2d');

        if (charts.projects) {
            charts.projects.destroy();
        }

        const statusCounts = {
            'active': projects.filter(p => p.status === 'active').length,
            'completed': projects.filter(p => p.status === 'completed').length,
            'on-hold': projects.filter(p => p.status === 'on-hold').length,
            'cancelled': projects.filter(p => p.status === 'cancelled').length
        };

        charts.projects = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['نشط', 'مكتمل', 'معلق', 'ملغي'],
                datasets: [{
                    label: 'عدد المشاريع',
                    data: [statusCounts.active, statusCounts.completed, statusCounts['on-hold'], statusCounts.cancelled],
                    backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444'],
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Create tasks chart
    function createTasksChart() {
        const ctx = document.getElementById('tasksChart').getContext('2d');

        if (charts.tasks) {
            charts.tasks.destroy();
        }

        const taskCounts = {
            'pending': tasks.filter(t => t.status === 'pending').length,
            'in-progress': tasks.filter(t => t.status === 'in-progress').length,
            'completed': tasks.filter(t => t.status === 'completed').length
        };

        charts.tasks = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['معلق', 'قيد التنفيذ', 'مكتمل'],
                datasets: [{
                    data: [taskCounts.pending, taskCounts['in-progress'], taskCounts.completed],
                    backgroundColor: ['#6b7280', '#3b82f6', '#10b981'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    // Create revenue chart
    function createRevenueChart() {
        const ctx = document.getElementById('revenueChart').getContext('2d');

        if (charts.revenue) {
            charts.revenue.destroy();
        }

        // Generate sample revenue data
        const months = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
            'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
        const revenueData = months.map(() => Math.floor(Math.random() * 50000) + 20000);

        charts.revenue = new Chart(ctx, {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'الإيرادات',
                    data: revenueData,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)'
                        },
                        ticks: {
                            callback: function (value) {
                                return formatCurrency(value);
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
    }

    // Create team performance chart
    function createTeamPerformanceChart() {
        const ctx = document.getElementById('teamPerformanceChart').getContext('2d');

        if (charts.teamPerformance) {
            charts.teamPerformance.destroy();
        }

        // Calculate performance data
        const departments = ['التطوير', 'التصميم', 'التسويق', 'المبيعات'];
        const performanceData = departments.map(() => Math.floor(Math.random() * 40) + 60);

        charts.teamPerformance = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: departments,
                datasets: [{
                    label: 'نسبة الإنجاز %',
                    data: performanceData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)'
                        },
                        pointLabels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        });
    }

    // Populate tables
    function populateTables() {
        populateProjectsTable();
        populateEmployeesTable();
    }

    // Populate projects table
    function populateProjectsTable() {
        const tbody = document.getElementById('projectsTableBody');
        const filteredProjects = filterProjectsByDate();

        tbody.innerHTML = filteredProjects.map(project => {
            const client = clients.find(c => c.id === project.client_id);
            const progress = Math.floor(Math.random() * 100);

            return `
                <tr>
                    <td>${project.name}</td>
                    <td>${client ? client.company_name : 'غير محدد'}</td>
                    <td>
                        <span class="status-${project.status}">
                            ${getStatusText(project.status)}
                        </span>
                    </td>
                    <td>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar" style="width: ${progress}%; background: #10b981;"></div>
                        </div>
                        <small>${progress}%</small>
                    </td>
                    <td>${formatCurrency(project.budget)}</td>
                    <td>${formatDate(project.end_date)}</td>
                </tr>
            `;
        }).join('');
    }

    // Populate employees table
    function populateEmployeesTable() {
        const tbody = document.getElementById('employeesTableBody');

        tbody.innerHTML = employees.map(employee => {
            const employeeTasks = tasks.filter(t => t.assignee_id === employee.id);
            const completedTasks = employeeTasks.filter(t => t.status === 'completed').length;
            const inProgressTasks = employeeTasks.filter(t => t.status === 'in-progress').length;
            const hoursWorked = Math.floor(Math.random() * 160) + 40;
            const completionRate = employeeTasks.length > 0 ? Math.round((completedTasks / employeeTasks.length) * 100) : 0;

            return `
                <tr>
                    <td>${employee.first_name} ${employee.last_name}</td>
                    <td>${getDepartmentText(employee.department)}</td>
                    <td>${completedTasks}</td>
                    <td>${inProgressTasks}</td>
                    <td>${hoursWorked} ساعة</td>
                    <td>
                        <span class="stat-change ${completionRate >= 80 ? 'positive' : 'negative'}">
                            ${completionRate}%
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update chart period
    function updateChartPeriod(period, element) {
        document.querySelectorAll('.chart-period').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // Here you would filter data by period and recreate charts
        showAlert(`تم تحديث البيانات للفترة: ${period}`, 'info');
    }

    // Export report
    function exportReport(format) {
        showAlert(`سيتم تصدير التقرير بصيغة ${format.toUpperCase()} قريباً`, 'info');
    }

    // Helper functions
    function getStatusText(status) {
        const statusMap = {
            'active': 'نشط',
            'completed': 'مكتمل',
            'on-hold': 'معلق',
            'cancelled': 'ملغي'
        };
        return statusMap[status] || status;
    }

    function getDepartmentText(department) {
        const departmentMap = {
            'development': 'التطوير',
            'design': 'التصميم',
            'marketing': 'التسويق',
            'sales': 'المبيعات',
            'hr': 'الموارد البشرية'
        };
        return departmentMap[department] || department || 'غير محدد';
    }

    function formatDate(dateString) {
        if (!dateString) return 'غير محدد';
        const date = new Date(dateString);
        return date.toLocaleDateString('ar-SA');
    }

    function formatCurrency(amount) {
        if (!amount) return '0 ر.س';
        return new Intl.NumberFormat('ar-SA', {
            style: 'currency',
            currency: 'SAR'
        }).format(amount);
    }
</script>
{% endblock %}