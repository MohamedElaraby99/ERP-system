{% extends "base_layout.html" %}

{% block title %}Ø§Ù„Ù…Ù‡Ø§Ù… - Ù†Ø¸Ø§Ù… ERP{% endblock %}
{% block page_title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…{% endblock %}

{% block extra_css %}
<style>
    :root {
        --task-pending: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        --task-progress: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        --task-completed: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --task-cancelled: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --task-onhold: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }

    .content-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 2rem;
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .page-title {
        font-size: 1.875rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.5rem;
    }

    .page-subtitle {
        color: #64748b;
        font-size: 1rem;
        margin-bottom: 0;
    }

    .content-actions {
        display: flex;
        gap: 1rem;
    }

    .btn-modern {
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.875rem;
        border: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary-modern {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .task-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .stat-card.pending::before {
        background: var(--task-pending);
    }

    .stat-card.progress::before {
        background: var(--task-progress);
    }

    .stat-card.completed::before {
        background: var(--task-completed);
    }

    .stat-card.total::before {
        background: var(--primary-gradient);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
        line-height: 1;
    }

    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    .add-task-section {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .form-control,
    .form-select {
        border-radius: 8px;
        border: 1px solid rgba(226, 232, 240, 0.8);
        transition: all 0.3s ease;
        padding: 0.75rem 1rem;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }

    .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }

    .tasks-grid {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.8);
    }

    .task-card {
        background: white;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(226, 232, 240, 0.6);
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .task-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    }

    .task-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        position: relative;
    }

    .task-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.5rem;
    }

    .task-body {
        padding: 1.5rem;
    }

    .task-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .meta-item {
        text-align: center;
        padding: 0.75rem;
        background: rgba(102, 126, 234, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(102, 126, 234, 0.1);
    }

    .meta-label {
        font-size: 0.75rem;
        color: #64748b;
        margin-bottom: 0.25rem;
    }

    .meta-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: #667eea;
    }

    .priority-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .priority-low {
        background: #d1fae5;
        color: #065f46;
    }

    .priority-medium {
        background: #fef3c7;
        color: #92400e;
    }

    .priority-high {
        background: #fecaca;
        color: #991b1b;
    }

    .priority-urgent {
        background: #e5e7eb;
        color: #1f2937;
    }

    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-pending {
        background: #ede9fe;
        color: #6b21a8;
    }

    .status-in_progress {
        background: #dbeafe;
        color: #1e40af;
    }

    .status-completed {
        background: #d1fae5;
        color: #065f46;
    }

    .status-on_hold {
        background: #fef3c7;
        color: #92400e;
    }

    .status-cancelled {
        background: #fecaca;
        color: #991b1b;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 3rem;
        color: #667eea;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #64748b;
    }

    .empty-state i {
        font-size: 4rem;
        color: #cbd5e0;
        margin-bottom: 1rem;
    }

    @media (max-width: 768px) {
        .content-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .task-stats {
            grid-template-columns: 1fr;
        }

        .task-meta {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Page Header -->
<div class="content-header">
    <div>
        <h1 class="page-title">
            <i class="fas fa-tasks me-2"></i>
            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…
        </h1>
        <p class="page-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
    </div>
    <div class="content-actions">
        <button class="btn btn-modern btn-primary-modern" onclick="showAddTaskForm()">
            <i class="fas fa-plus me-2"></i>
            Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
    </div>
</div>

<!-- Statistics -->
<div class="task-stats">
    <div class="stat-card pending">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--task-pending);">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-number" id="pendingCount">0</div>
        </div>
        <div class="stat-label">Ù…Ù‡Ø§Ù… Ù…Ø¹Ù„Ù‚Ø©</div>
    </div>

    <div class="stat-card progress">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--task-progress);">
                <i class="fas fa-cog fa-spin"></i>
            </div>
            <div class="stat-number" id="progressCount">0</div>
        </div>
        <div class="stat-label">Ù…Ù‡Ø§Ù… Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
    </div>

    <div class="stat-card completed">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--task-completed);">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-number" id="completedCount">0</div>
        </div>
        <div class="stat-label">Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø©</div>
    </div>

    <div class="stat-card total">
        <div class="stat-header">
            <div class="stat-icon" style="background: var(--primary-gradient);">
                <i class="fas fa-list"></i>
            </div>
            <div class="stat-number" id="totalCount">0</div>
        </div>
        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù‡Ø§Ù…</div>
    </div>
    </div>

    <!-- Add Task Form -->
<div class="add-task-section" id="addTaskSection" style="display: none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
            <i class="fas fa-plus-circle me-2 text-primary"></i>
            Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="hideAddTaskForm()">
            <i class="fas fa-times"></i>
        </button>
    </div>

        <form id="taskForm">
        <!-- Basic Information -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                </h6>
            </div>
            <div class="col-md-6">
                    <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© *</label>
                    <input type="text" class="form-control" id="taskTitle" required>
                </div>
            <div class="col-md-6">
                    <label class="form-label">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ *</label>
                    <select class="form-select" id="taskProject" required>
                    <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹...</option>
                    </select>
                </div>
        </div>

        <!-- Assignment & Priority -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="fas fa-user-cog me-2"></i>
                    Ø§Ù„ØªØ®ØµÙŠØµ ÙˆØ§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
                </h6>
            </div>
            <div class="col-md-6">
                    <label class="form-label">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙƒÙ„Ù *</label>
                    <select class="form-select" id="taskAssignee" required>
                    <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†...</option>
                    </select>
                </div>
            <div class="col-md-6">
                    <label class="form-label">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
                    <select class="form-select" id="taskPriority">
                        <option value="low">Ù…Ù†Ø®ÙØ¶Ø©</option>
                        <option value="medium" selected>Ù…ØªÙˆØ³Ø·Ø©</option>
                        <option value="high">Ø¹Ø§Ù„ÙŠØ©</option>
                        <option value="urgent">Ø¹Ø§Ø¬Ù„Ø©</option>
                    </select>
                </div>
            </div>

        <!-- Dates -->
        <div class="row mb-4">
            <div class="col-12">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
                </h6>
            </div>
            <div class="col-md-6">
                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *</label>
                    <input type="date" class="form-control" id="taskStart" required>
                </div>
            <div class="col-md-6">
                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
                    <input type="date" class="form-control" id="taskDue" required>
                </div>
            </div>

        <!-- Description -->
        <div class="row mb-4">
            <div class="col-12">
                <label class="form-label">ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                <textarea class="form-control" id="taskDesc" rows="3"
                    placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ù„Ù„Ù…Ù‡Ù…Ø©..."></textarea>
            </div>
        </div>

        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-modern btn-primary-modern">
                <i class="fas fa-save me-2"></i>Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="resetTaskForm()">
                <i class="fas fa-undo me-2"></i>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
            </button>
        </div>

            <div id="taskMessage" class="mt-3"></div>
        </form>
</div>

<!-- Tasks Grid -->
<div class="tasks-grid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h5>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="statusFilter" style="width: auto;">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                <option value="pending">Ù…Ø¹Ù„Ù‚Ø©</option>
                <option value="in_progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                <option value="completed">Ù…ÙƒØªÙ…Ù„Ø©</option>
                <option value="on_hold">Ù…ØªÙˆÙ‚ÙØ©</option>
                <option value="cancelled">Ù…Ù„ØºØ§Ø©</option>
            </select>
            <button class="btn btn-sm btn-outline-primary" onclick="refreshTasks()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </div>

    <!-- Loading state -->
    <div id="loadingState" class="loading-spinner" style="display: none;">
        <div class="spinner-border text-primary me-3" role="status">
            <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <h5 class="mb-0">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h5>
    </div>

    <!-- Tasks List -->
        <div id="tasksList">
        <div class="empty-state">
            <i class="fas fa-tasks"></i>
            <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</h4>
            <p>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let tasks = [];
    let projects = [];
    let employees = [];

    // API configuration - WITH JWT AUTHENTICATION
    const API_BASE = '/api/v1';

    // JWT Token management
    function getAuthToken() {
        return localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
    }

    function getAuthHeaders() {
        const token = getAuthToken();
        return {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            ...(token && { 'Authorization': `Bearer ${token}` })
        };
    }

    function redirectToLogin() {
        const currentPath = window.location.pathname + window.location.search;
        window.location.href = `/login?return_to=${encodeURIComponent(currentPath)}`;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        console.log('ğŸš€ Tasks page loaded - WITH JWT AUTHENTICATION');

        // Check if user is authenticated
        const token = getAuthToken();
        if (!token) {
            console.log('âŒ No authentication token found, redirecting to login');
            redirectToLogin();
            return;
        }

        // Load everything from backend
        loadAllData();

        // Set default dates
        setDefaultDates();

        // Add event listeners
        addEventListeners();
    });

    // Load all data from backend
    async function loadAllData() {
        console.log('ğŸ“¡ Loading ALL data from Flask backend with JWT...');
        showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');

        try {
            await Promise.all([
                loadProjectsFromAPI(),
                loadEmployeesFromAPI(),
                loadTasksFromAPI(),
                loadStatisticsFromAPI()
            ]);
            console.log('âœ… ALL DATA LOADED FROM BACKEND WITH AUTH');
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);

            // Check if it's an auth error
            if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                console.log('ğŸ” Authentication failed, redirecting to login');
                redirectToLogin();
                return;
            }

            displayEmptyState();
        } finally {
            hideLoading();
        }
    }

    // Load projects from API - WITH JWT
    async function loadProjectsFromAPI() {
        try {
            console.log('ğŸ“¡ GET /api/v1/projects with JWT');

            const response = await fetch('/api/v1/projects', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            console.log('ğŸ“¡ Projects API Response:', response.status);

            if (response.status === 401) {
                throw new Error('401 Unauthorized');
            }

            if (response.ok) {
                const data = await response.json();
                console.log('ğŸ“‚ Projects DATA:', data);

                // Handle response
                projects = Array.isArray(data) ? data : (data.projects || []);
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${projects.length} Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

                populateProjectsSelect();
            } else {
                console.error('âŒ Projects API Error:', response.status);
                throw new Error(`Projects API Error: ${response.status}`);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹:', error);
            throw error;
        }
    }

    // Load employees from API - WITH JWT  
    async function loadEmployeesFromAPI() {
        try {
            console.log('ğŸ“¡ GET /api/v1/employees with JWT');

            const response = await fetch('/api/v1/employees', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            console.log('ğŸ“¡ Employees API Response:', response.status);

            if (response.status === 401) {
                throw new Error('401 Unauthorized');
            }

            if (response.ok) {
                const data = await response.json();
                console.log('ğŸ‘¥ Employees DATA:', data);

                // Handle response
                employees = Array.isArray(data) ? data : (data.employees || []);
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${employees.length} Ù…ÙˆØ¸Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

                populateEmployeesSelect();
            } else {
                console.error('âŒ Employees API Error:', response.status);
                throw new Error(`Employees API Error: ${response.status}`);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†:', error);
            throw error;
        }
    }

    // Populate projects select
    function populateProjectsSelect() {
        const select = document.getElementById('taskProject');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</option>';

        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project.id;
            option.textContent = project.name;
            select.appendChild(option);
        });

        console.log('âœ… ØªÙ… Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
    }

    // Populate employees select
    function populateEmployeesSelect() {
                const select = document.getElementById('taskAssignee');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>';

        employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.first_name} ${employee.last_name}`;
                    select.appendChild(option);
                });

        console.log('âœ… ØªÙ… Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
    }

    // Load tasks from API - WITH JWT
    async function loadTasksFromAPI() {
        try {
            console.log('ğŸ“¡ GET /api/v1/tasks with JWT');

            const response = await fetch('/api/v1/tasks', {
                method: 'GET',
                headers: getAuthHeaders()
            });

            console.log('ğŸ“¡ Tasks API Response:', response.status);

            if (response.status === 401) {
                throw new Error('401 Unauthorized');
            }

            if (response.ok) {
                const data = await response.json();
                console.log('ğŸ“‹ Tasks DATA:', data);

                // Handle response
                tasks = Array.isArray(data) ? data : (data.tasks || []);
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${tasks.length} Ù…Ù‡Ù…Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

                displayTasksFromDB(tasks);
            } else {
                console.error('âŒ Tasks API Error:', response.status);
                throw new Error(`Tasks API Error: ${response.status}`);
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…:', error);
            throw error;
        }
    }

    // Load statistics from API - WITH JWT  
    async function loadStatisticsFromAPI() {
        try {
            console.log('ğŸ“Š Calculating task statistics from loaded data...');

            if (tasks.length === 0) {
                updateTaskStatistics({
                    pending: 0,
                    in_progress: 0,
                    completed: 0,
                    total: 0
                });
                return;
            }

            // Calculate statistics from loaded tasks
            const stats = {
                pending: tasks.filter(t => t.status === 'pending').length,
                in_progress: tasks.filter(t => t.status === 'in_progress').length,
                completed: tasks.filter(t => t.status === 'completed').length,
                total: tasks.length
            };

            console.log('ğŸ“Š Task statistics:', stats);
            updateTaskStatistics(stats);
        } catch (error) {
            console.error('âŒ Statistics error:', error);
        }
    }

    // Update task statistics display
    function updateTaskStatistics(stats) {
        document.getElementById('pendingCount').textContent = stats.pending || 0;
        document.getElementById('progressCount').textContent = stats.in_progress || 0;
        document.getElementById('completedCount').textContent = stats.completed || 0;
        document.getElementById('totalCount').textContent = stats.total || 0;

        console.log('ğŸ“Š Task statistics updated in UI');
    }

    // Display tasks from database
    function displayTasksFromDB(tasksList) {
        const container = document.getElementById('tasksList');

        console.log(`ğŸ–¼ï¸ Ø¹Ø±Ø¶ ${tasksList.length} Ù…Ù‡Ù…Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª`);

        if (tasksList.length === 0) {
            displayEmptyState();
            return;
        }

        container.innerHTML = tasksList.map(task => createTaskCardHTML(task)).join('');
    }

    // Create task card HTML
    function createTaskCardHTML(task) {
        const project = projects.find(p => p.id === task.project_id);
        const employee = employees.find(e => e.id === task.assignee_id);

        const projectName = project ? project.name : 'Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const employeeName = employee ? `${employee.first_name} ${employee.last_name}` : 'Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

        return `
            <div class="task-card">
                <div class="task-header">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="priority-badge priority-${task.priority}">${getPriorityText(task.priority)}</div>
                        <div class="status-badge status-${task.status}">${getStatusText(task.status)}</div>
                    </div>
                    <div class="task-title">${task.title}</div>
                    <div class="text-muted small">${task.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­'}</div>
                </div>
                <div class="task-body">
                    <div class="task-meta">
                        <div class="meta-item">
                            <div class="meta-label">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</div>
                            <div class="meta-value">${projectName}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…ÙƒÙ„Ù</div>
                            <div class="meta-value">${employeeName}</div>
                        </div>
                    </div>
                    <div class="task-meta">
                        <div class="meta-item">
                            <div class="meta-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</div>
                            <div class="meta-value">${formatDate(task.start_date)}</div>
                        </div>
                        <div class="meta-item">
                            <div class="meta-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</div>
                            <div class="meta-value">${formatDate(task.due_date)}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Display empty state
    function displayEmptyState() {
        const container = document.getElementById('tasksList');
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tasks"></i>
                <h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>
                <p>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
        </div>
        `;
    }

    // Add task to database - WITH JWT
    async function addTask() {
        const taskData = {
            title: document.getElementById('taskTitle').value.trim(),
            project_id: parseInt(document.getElementById('taskProject').value),
            assignee_id: parseInt(document.getElementById('taskAssignee').value),
            priority: document.getElementById('taskPriority').value,
            start_date: document.getElementById('taskStart').value,
            due_date: document.getElementById('taskDue').value,
            description: document.getElementById('taskDesc').value.trim()
        };

        // Validation
        if (!taskData.title || !taskData.project_id || !taskData.assignee_id || !taskData.start_date || !taskData.due_date) {
            showMessage('âŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙŠØ¬Ø¨ Ù…Ù„Ø¤Ù‡Ø§', 'danger');
            return;
        }

        // Validate dates
        if (new Date(taskData.start_date) > new Date(taskData.due_date)) {
            showMessage('âŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡', 'danger');
            return;
        }

        try {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
            console.log('ğŸ’¾ Adding task to database with JWT:', taskData);

            const response = await fetch('/api/v1/tasks', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(taskData)
            });

            console.log('ğŸ’¾ Add task response:', response.status);

            if (response.status === 401) {
                showMessage('âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'danger');
                redirectToLogin();
                return;
            }

            if (response.ok) {
                const result = await response.json();
                showMessage('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');

                // Reset form and hide it
                resetTaskForm();
                hideAddTaskForm();

                // Reload from database
                await loadAllData();

                console.log('âœ… Task added to database:', result);
            } else {
                const error = await response.text();
                showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù‡Ù…Ø©: ' + error, 'danger');
            }
        } catch (error) {
            console.error('âŒ Add task error:', error);
            showMessage('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'danger');
        } finally {
            hideLoading();
        }
    }

    // UI Helper Functions
    function showAddTaskForm() {
        document.getElementById('addTaskSection').style.display = 'block';
        document.getElementById('taskTitle').focus();
    }

    function hideAddTaskForm() {
        document.getElementById('addTaskSection').style.display = 'none';
    }

    function resetTaskForm() {
        document.getElementById('taskForm').reset();
        setDefaultDates();
        document.getElementById('taskMessage').innerHTML = '';
    }

    function setDefaultDates() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('taskStart').value = today;

        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        document.getElementById('taskDue').value = nextWeek.toISOString().split('T')[0];
    }

    function addEventListeners() {
        document.getElementById('taskForm').addEventListener('submit', function (e) {
            e.preventDefault();
            addTask();
        });

        document.getElementById('statusFilter').addEventListener('change', filterTasks);
    }

    function filterTasks() {
        const statusFilter = document.getElementById('statusFilter').value;
        let filteredTasks = [...tasks];

        if (statusFilter) {
            filteredTasks = filteredTasks.filter(task => task.status === statusFilter);
        }

        displayTasksFromDB(filteredTasks);
        console.log(`ğŸ” ØªÙ… ÙÙ„ØªØ±Ø© ${filteredTasks.length} Ù…Ù‡Ù…Ø© Ù…Ù† Ø£ØµÙ„ ${tasks.length}`);
    }

    function refreshTasks() {
        loadAllData();
    }

    function showMessage(message, type) {
        const messageDiv = document.getElementById('taskMessage');
        messageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => {
            messageDiv.innerHTML = '';
        }, 5000);
    }

    function formatDate(dateString) {
        if (!dateString) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        return new Date(dateString).toLocaleDateString('ar-SA');
    }

    function getPriorityText(priority) {
        const priorities = {
            'low': 'Ù…Ù†Ø®ÙØ¶Ø©',
            'medium': 'Ù…ØªÙˆØ³Ø·Ø©',
            'high': 'Ø¹Ø§Ù„ÙŠØ©',
            'urgent': 'Ø¹Ø§Ø¬Ù„Ø©'
        };
        return priorities[priority] || priority;
    }

    function getStatusText(status) {
        const statuses = {
            'pending': 'Ù…Ø¹Ù„Ù‚Ø©',
            'in_progress': 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
            'completed': 'Ù…ÙƒØªÙ…Ù„Ø©',
            'on_hold': 'Ù…ØªÙˆÙ‚ÙØ©',
            'cancelled': 'Ù…Ù„ØºØ§Ø©'
        };
        return statuses[status] || status;
    }

    // UI feedback functions
    function showLoading(message) {
        console.log('â³ ' + message);
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'flex';
            const h5 = loadingState.querySelector('h5');
            if (h5) h5.textContent = message;
        }
    }

    function hideLoading() {
        console.log('âœ“ ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„');
        const loadingState = document.getElementById('loadingState');
        if (loadingState) {
            loadingState.style.display = 'none';
        }
    }

    // Make functions globally available
    window.showAddTaskForm = showAddTaskForm;
    window.hideAddTaskForm = hideAddTaskForm;
    window.resetTaskForm = resetTaskForm;
    window.filterTasks = filterTasks;
    window.refreshTasks = refreshTasks;
    window.addTask = addTask;
</script>
{% endblock %}